
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Bias Correction of Climate Model Output &#8212; My sample book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/methods/Bias_Correction_Application/Walkthrough Tutorial';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Content needs filling." href="../gradient_boosted_trees.html" />
    <link rel="prev" title="UKCEH Data Science Book" href="../../../intro.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/UKCEH_EDST_Logo.png" class="logo__image only-light" alt="My sample book - Home"/>
    <script>document.write(`<img src="../../../_static/UKCEH_EDST_Logo.png" class="logo__image only-dark" alt="My sample book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../intro.html">
                    UKCEH Data Science Book
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Methodology Notebooks</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Bias Correction of Climate Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gradient_boosted_trees.html">Downscaling UK Surface Ozone</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stochastic_partial_diff_equations.html">UK Species Distribution Modelling</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Templates</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../template.html">Methodology Notebook</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/Jez-Carter/UKCEH_Data_Science_Book/master?urlpath=tree/docs/notebooks/methods/Bias_Correction_Application/Walkthrough Tutorial.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="../../../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li><a href="https://deepnote.com/github/Jez-Carter/UKCEH_Data_Science_Book/blob/master/docs/notebooks/methods/Bias_Correction_Application/Walkthrough Tutorial.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/Jez-Carter/UKCEH_Data_Science_Book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/Jez-Carter/UKCEH_Data_Science_Book/issues/new?title=Issue%20on%20page%20%2Fnotebooks/methods/Bias_Correction_Application/Walkthrough Tutorial.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/notebooks/methods/Bias_Correction_Application/Walkthrough Tutorial.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Bias Correction of Climate Model Output</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#importing-required-libraries-and-loading-data">Importing Required Libraries and Loading Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-exploration">Data Exploration</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-distribution-of-weather-stations">Spatial Distribution of Weather Stations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#time-series-and-distribution-of-single-weather-station-manuela">Time Series and Distribution of Single Weather Station (Manuela)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pairplots">Pairplots</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#examining-spatial-covariance-after-removing-influence-of-elevation-and-latitude">Examining spatial covariance after removing influence of elevation and latitude</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#examining-spatial-covariance-in-the-bias">Examining spatial covariance in the bias</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#examining-relationships-between-variables-and-the-bias-in-parameters">Examining relationships between variables and the bias in parameters</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-preprocessing">Data Preprocessing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-the-model">Defining the model</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#splitting-up-the-model-for-computation">Splitting up the model for computation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#parameter-inference">Parameter Inference</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#inference-on-parameters-of-the-mean-function">Inference on parameters of the mean function</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#inference-on-parameters-of-the-residual-and-covariance-functions">Inference on parameters of the residual and covariance functions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#making-posterior-predictive-estimates-of-the-unbiased-mean-and-variance-across-the-domain">Making posterior predictive estimates of the unbiased mean and variance across the domain</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="bias-correction-of-climate-model-output">
<h1>Bias Correction of Climate Model Output<a class="headerlink" href="#bias-correction-of-climate-model-output" title="Link to this heading">#</a></h1>
<p><a class="sd-sphinx-override sd-badge sd-bg-info sd-bg-text-info reference external" href="https://eprints.lancs.ac.uk/id/eprint/222620/1/2024jeremycarterphd.pdf"><span>Paper (Chapter 4)</span></a>
<a class="sd-sphinx-override sd-badge sd-bg-info sd-bg-text-info reference external" href="https://github.com/Jez-Carter/Bias_Correction_Application/tree/jupyterbook_render"><span>Code Repository (Branch jupyterbook_render)</span></a></p>
<div class="sd-card sd-sphinx-override sd-mb-3 sd-shadow-sm docutils">
<div class="sd-card-body docutils">
<div class="sd-card-title sd-font-weight-bold docutils">
Challenge:</div>
<p class="sd-card-text">Climate models are highly-complex and highly-multidimensional. They typically observe a non-insignificant bias in particular variables of interest. In-situ measurements of variables can be used to help apply a bias correction. Where the in-situ measurements are sparse it’s important to consider uncertainty, depending on factors such as the underlying spatial covariance between points.</p>
</div>
</div>
<div class="sd-card sd-sphinx-override sd-mb-3 sd-shadow-sm docutils">
<div class="sd-card-body docutils">
<div class="sd-card-title sd-font-weight-bold docutils">
Approach:</div>
<p class="sd-card-text">Gaussian processes are used to explicitly model spatial covariance between points and to estimate uncertainties when applying bias correction across the whole domain. A Bayesian hierarchical model is constructed to promote uncertainty propagation across the different components of the model.</p>
</div>
</div>
<div class="note dropdown admonition">
<p class="admonition-title">Statistical Concepts:</p>
<p>Gaussian processes represent probability distributions over a function of values by considering the covariance between points. For example, consider some spatial surface of mean temperature over a region. The values will vary smoothly over the domain and so values of nearby points are spatially correlated. To interpolate across the surface and to express what the likelihood is of the particular surface of values observed you need to consider the spatial correlation. This is what Gaussian processes do by parameterising the covariance as a function of distance between points. Since Gaussian processes represent a probability distribution over the function you can estimate an expectation and also uncertainty in predictions.</p>
</div>
<div class="note dropdown admonition">
<p class="admonition-title">Generalisability:</p>
<p>Gaussian processes are highly generalisable as they don’t assume a fixed functional form of the underlying process. That is many different types of spatial and/or temporal surfaces can be modelled adequately through them, including oscillatory functions for example. They are applicable across domains such as regression, classification, time-series modelling and spatial analysis. Gaussian processes are also highly interpretable and resistant to overfitting due to being defined by a limited number of hyper-parameters. Finally, providing a probabilistic approach, they also capture uncertainty in estimates, important for various real-world applications and data science pipelines leading to decision-making. The specific example in this notebook is generalisable to any scenario involving combining multiple spatio-temporal datasets, particularly when a good-coverage biased dataset is combined with a poor-coverage unbiased dataset.</p>
</div>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#introduction" id="id1">Introduction</a></p></li>
<li><p><a class="reference internal" href="#importing-required-libraries-and-loading-data" id="id2">Importing Required Libraries and Loading Data</a></p></li>
<li><p><a class="reference internal" href="#data-exploration" id="id3">Data Exploration</a></p>
<ul>
<li><p><a class="reference internal" href="#spatial-distribution-of-weather-stations" id="id4">Spatial Distribution of Weather Stations</a></p></li>
<li><p><a class="reference internal" href="#time-series-and-distribution-of-single-weather-station-manuela" id="id5">Time Series and Distribution of Single Weather Station (Manuela)</a></p></li>
<li><p><a class="reference internal" href="#pairplots" id="id6">Pairplots</a></p></li>
<li><p><a class="reference internal" href="#examining-spatial-covariance-after-removing-influence-of-elevation-and-latitude" id="id7">Examining spatial covariance after removing influence of elevation and latitude</a></p></li>
<li><p><a class="reference internal" href="#examining-spatial-covariance-in-the-bias" id="id8">Examining spatial covariance in the bias</a></p></li>
<li><p><a class="reference internal" href="#examining-relationships-between-variables-and-the-bias-in-parameters" id="id9">Examining relationships between variables and the bias in parameters</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#data-preprocessing" id="id10">Data Preprocessing</a></p></li>
<li><p><a class="reference internal" href="#defining-the-model" id="id11">Defining the model</a></p>
<ul>
<li><p><a class="reference internal" href="#splitting-up-the-model-for-computation" id="id12">Splitting up the model for computation</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#parameter-inference" id="id13">Parameter Inference</a></p>
<ul>
<li><p><a class="reference internal" href="#inference-on-parameters-of-the-mean-function" id="id14">Inference on parameters of the mean function</a></p></li>
<li><p><a class="reference internal" href="#inference-on-parameters-of-the-residual-and-covariance-functions" id="id15">Inference on parameters of the residual and covariance functions</a></p></li>
<li><p><a class="reference internal" href="#making-posterior-predictive-estimates-of-the-unbiased-mean-and-variance-across-the-domain" id="id16">Making posterior predictive estimates of the unbiased mean and variance across the domain</a></p></li>
</ul>
</li>
</ul>
</nav>
<!-- https://jupyterbook.org/en/stable/structure/configure.html --><section id="introduction">
<h2><a class="toc-backref" href="#id1" role="doc-backlink">Introduction</a><a class="headerlink" href="#introduction" title="Link to this heading">#</a></h2>
<p>This notebook demonstrates an approach to bias correction that utilises Gaussian Processes (GPs) and a Bayesian hierarchical framework. The method is applied to bias correcting temperature data from a climate model over Antarctica using in-situ observations from automatic weather stations. Since the weather stations are both spatially and temporally sparse it’s important to capture uncertainty in the correction. Further detail is available at: <a class="reference external" href="https://eprints.lancs.ac.uk/id/eprint/222620/1/2024jeremycarterphd.pdf">J.Carter Thesis (Chapter 4)</a>. The code is in ongoing development and is available at: <a class="reference external" href="https://github.com/Jez-Carter/Bias_Correction_Application.git">Bias Correction Application</a>. The datasets and modules needed to run this notebook are available via the <a class="reference external" href="https://github.com/Jez-Carter/Bias_Correction_Application/tree/jupyterbook_render">jupterbook_render branch</a> of the repository.</p>
</section>
<section id="importing-required-libraries-and-loading-data">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Importing Required Libraries and Loading Data</a><a class="headerlink" href="#importing-required-libraries-and-loading-data" title="Link to this heading">#</a></h2>
<p>The data for this tutorial is stored as NetCDF files. This is a common file format for climate model output and is handled well by the Xarray Python package, which can be thought of as a Pandas equivalent for efficient handling of multidimensional data. Xarray loads data as ‘datasets’ and ‘dataarrays’. The model in this tutorial is defined using the Python packages Numpyro and TinyGP, which are compatible. Numpyro provides an intuitive probabilistic programming language for Bayesian statistics, built ontop of JAX and with NumPy based syntax. TinyGP provides a lightweight and intuitive package for working with Gaussian Process objects.</p>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Importing libraries</span>
<span class="kn">import</span> <span class="nn">pickle</span> 
<span class="kn">import</span> <span class="nn">timeit</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="kn">import</span> <span class="n">distance</span>
<span class="kn">import</span> <span class="nn">arviz</span> <span class="k">as</span> <span class="nn">az</span>
<span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">random</span>
<span class="kn">import</span> <span class="nn">numpyro</span>
<span class="kn">import</span> <span class="nn">numpyro.distributions</span> <span class="k">as</span> <span class="nn">dist</span>
<span class="kn">from</span> <span class="nn">numpyro.infer</span> <span class="kn">import</span> <span class="n">MCMC</span><span class="p">,</span> <span class="n">NUTS</span>
<span class="kn">from</span> <span class="nn">tinygp</span> <span class="kn">import</span> <span class="n">kernels</span><span class="p">,</span> <span class="n">GaussianProcess</span>
<span class="kn">from</span> <span class="nn">tinygp.kernels.distance</span> <span class="kn">import</span> <span class="n">L2Distance</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>

<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">cartopy.crs</span> <span class="k">as</span> <span class="nn">ccrs</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.lines</span> <span class="k">as</span> <span class="nn">mlines</span>

<span class="n">rng_key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">jax</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s2">&quot;jax_enable_x64&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/jez/miniconda3/envs/jbook_BCA/lib/python3.10/site-packages/tqdm/auto.py:21: TqdmWarning: IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user_install.html
  from .autonotebook import tqdm as notebook_tqdm
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Loading Data</span>
<span class="n">data_path</span> <span class="o">=</span> <span class="s1">&#39;/home/jez/Bias_Correction_Application/walkthrough_tutorial/tutorial_data/&#39;</span>

<span class="n">ds_aws</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data_path</span><span class="si">}</span><span class="s1">ds_aws.nc&#39;</span><span class="p">)</span> <span class="c1"># Automatic Weather Station Data</span>
<span class="n">ds_climate</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data_path</span><span class="si">}</span><span class="s1">ds_climate.nc&#39;</span><span class="p">)</span> <span class="c1"># Climate Model Data</span>
</pre></div>
</div>
</div>
</div>
<p>Using Xarray datasets provides nice interactive tables of the multidimensional data:</p>
<div class="cell tag_hide-output docutils container">
<div class="cell_input above-output-prompt docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Displaying the AWS data</span>
<span class="n">ds_aws</span> 
</pre></div>
</div>
</div>
<details class="hide below-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell output</span>
<span class="expanded">Hide code cell output</span>
</summary>
<div class="cell_output docutils container">
<div class="output text_html"><div><svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewBox="0 0 32 32">
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewBox="0 0 32 32">
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme="dark"],
html[data-theme="dark"],
body[data-theme="dark"],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1f1f1f;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block !important;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 0 20px 0 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: inline-block;
  opacity: 0;
  height: 0;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:focus + label {
  border: 2px solid var(--xr-font-color0);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: "►";
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: "▼";
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: "(";
}

.xr-dim-list:after {
  content: ")";
}

.xr-dim-list li:not(:last-child):after {
  content: ",";
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-index-preview {
  grid-column: 2 / 5;
  color: var(--xr-font-color2);
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data,
.xr-index-data-in:checked ~ .xr-index-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-index-name div,
.xr-index-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2,
.xr-no-icon {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style><pre class='xr-text-repr-fallback'>&lt;xarray.Dataset&gt; Size: 925kB
Dimensions:         (station: 219, t: 504)
Coordinates:
  * station         (station) &lt;U22 19kB &#x27;AGO Site&#x27; &#x27;AGO-4&#x27; ... &#x27;aws16&#x27; &#x27;aws17&#x27;
    glat            (station) float64 2kB ...
    glon            (station) float64 2kB ...
    grid_latitude   (station) float64 2kB ...
    grid_longitude  (station) float64 2kB ...
    year            (t) float64 4kB ...
    month           (t) float64 4kB ...
  * t               (t) float64 4kB 1.0 2.0 3.0 4.0 ... 501.0 502.0 503.0 504.0
Data variables:
    latitude        (station) float64 2kB ...
    elevation       (station) float64 2kB ...
    temperature     (station, t) float64 883kB ...</pre><div class='xr-wrap' style='display:none'><div class='xr-header'><div class='xr-obj-type'>xarray.Dataset</div></div><ul class='xr-sections'><li class='xr-section-item'><input id='section-7f7cacc3-0f6b-4577-b969-d1640d222561' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-7f7cacc3-0f6b-4577-b969-d1640d222561' class='xr-section-summary'  title='Expand/collapse section'>Dimensions:</label><div class='xr-section-inline-details'><ul class='xr-dim-list'><li><span class='xr-has-index'>station</span>: 219</li><li><span class='xr-has-index'>t</span>: 504</li></ul></div><div class='xr-section-details'></div></li><li class='xr-section-item'><input id='section-877260e4-951d-48bd-a62c-f608175c2534' class='xr-section-summary-in' type='checkbox'  checked><label for='section-877260e4-951d-48bd-a62c-f608175c2534' class='xr-section-summary' >Coordinates: <span>(8)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>station</span></div><div class='xr-var-dims'>(station)</div><div class='xr-var-dtype'>&lt;U22</div><div class='xr-var-preview xr-preview'>&#x27;AGO Site&#x27; &#x27;AGO-4&#x27; ... &#x27;aws17&#x27;</div><input id='attrs-11464793-df23-495a-8472-b3d3b0e2c984' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-11464793-df23-495a-8472-b3d3b0e2c984' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-f67ac0c1-94ad-49e5-970a-9404f7db307d' class='xr-var-data-in' type='checkbox'><label for='data-f67ac0c1-94ad-49e5-970a-9404f7db307d' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([&#x27;AGO Site&#x27;, &#x27;AGO-4&#x27;, &#x27;AGO-5&#x27;, ..., &#x27;aws15&#x27;, &#x27;aws16&#x27;, &#x27;aws17&#x27;],
      shape=(219,), dtype=&#x27;&lt;U22&#x27;)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>glat</span></div><div class='xr-var-dims'>(station)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>...</div><input id='attrs-94c81fa9-a5e9-446f-b22e-52bfd717673b' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-94c81fa9-a5e9-446f-b22e-52bfd717673b' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-372d19d6-88f6-4d55-9876-fbb31dcb4a97' class='xr-var-data-in' type='checkbox'><label for='data-372d19d6-88f6-4d55-9876-fbb31dcb4a97' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>[219 values with dtype=float64]</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>glon</span></div><div class='xr-var-dims'>(station)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>...</div><input id='attrs-d0d21528-09e1-412e-a155-fb74eefc68c7' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-d0d21528-09e1-412e-a155-fb74eefc68c7' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-e2f09289-cce7-400c-a199-9f62873d0154' class='xr-var-data-in' type='checkbox'><label for='data-e2f09289-cce7-400c-a199-9f62873d0154' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>[219 values with dtype=float64]</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>grid_latitude</span></div><div class='xr-var-dims'>(station)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>...</div><input id='attrs-d8b06615-7d23-41e3-9f1a-7c668f0c15ad' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-d8b06615-7d23-41e3-9f1a-7c668f0c15ad' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-42f7cb56-69e7-4e0e-9d40-8ce74a3b74a5' class='xr-var-data-in' type='checkbox'><label for='data-42f7cb56-69e7-4e0e-9d40-8ce74a3b74a5' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>[219 values with dtype=float64]</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>grid_longitude</span></div><div class='xr-var-dims'>(station)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>...</div><input id='attrs-e84e8af9-3a26-4eb8-9b71-271afbe82eda' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-e84e8af9-3a26-4eb8-9b71-271afbe82eda' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-0124c3d7-d18d-4bc0-bf10-6494308c88dd' class='xr-var-data-in' type='checkbox'><label for='data-0124c3d7-d18d-4bc0-bf10-6494308c88dd' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>[219 values with dtype=float64]</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>year</span></div><div class='xr-var-dims'>(t)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>...</div><input id='attrs-6b21570d-50fc-4942-a108-18c85af28c04' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-6b21570d-50fc-4942-a108-18c85af28c04' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-221d00f0-49dc-4f05-9b2b-b59e9fd3df90' class='xr-var-data-in' type='checkbox'><label for='data-221d00f0-49dc-4f05-9b2b-b59e9fd3df90' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>[504 values with dtype=float64]</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>month</span></div><div class='xr-var-dims'>(t)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>...</div><input id='attrs-72b69724-307b-4021-80ee-bc25cbf9378c' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-72b69724-307b-4021-80ee-bc25cbf9378c' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-899ed1e4-f209-4485-b37d-93ae31357855' class='xr-var-data-in' type='checkbox'><label for='data-899ed1e4-f209-4485-b37d-93ae31357855' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>[504 values with dtype=float64]</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>t</span></div><div class='xr-var-dims'>(t)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>1.0 2.0 3.0 ... 502.0 503.0 504.0</div><input id='attrs-6b0f8c2a-bdf0-49ee-87fa-8f19fc199f04' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-6b0f8c2a-bdf0-49ee-87fa-8f19fc199f04' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-b08aec2f-cf22-4ded-b744-5d84ae7075a4' class='xr-var-data-in' type='checkbox'><label for='data-b08aec2f-cf22-4ded-b744-5d84ae7075a4' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([  1.,   2.,   3., ..., 502., 503., 504.], shape=(504,))</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-5cf643cc-6594-44aa-8dd7-6a9f7c2ca106' class='xr-section-summary-in' type='checkbox'  checked><label for='section-5cf643cc-6594-44aa-8dd7-6a9f7c2ca106' class='xr-section-summary' >Data variables: <span>(3)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span>latitude</span></div><div class='xr-var-dims'>(station)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>...</div><input id='attrs-68c3017d-9122-43ce-b16e-441ee27b44a3' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-68c3017d-9122-43ce-b16e-441ee27b44a3' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-cca2d39d-733d-4e28-bc84-570e2dda2362' class='xr-var-data-in' type='checkbox'><label for='data-cca2d39d-733d-4e28-bc84-570e2dda2362' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>[219 values with dtype=float64]</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>elevation</span></div><div class='xr-var-dims'>(station)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>...</div><input id='attrs-e62890d3-6cc4-416d-88ab-61abfde5f683' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-e62890d3-6cc4-416d-88ab-61abfde5f683' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-2d504ba6-20dc-4629-b769-79f437ddffaa' class='xr-var-data-in' type='checkbox'><label for='data-2d504ba6-20dc-4629-b769-79f437ddffaa' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>[219 values with dtype=float64]</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>temperature</span></div><div class='xr-var-dims'>(station, t)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>...</div><input id='attrs-5c77c583-19a5-45b3-ade7-a74a61b6e62e' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-5c77c583-19a5-45b3-ade7-a74a61b6e62e' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-ef756f4f-0fe7-4d74-9e70-5a6e1ed0bc74' class='xr-var-data-in' type='checkbox'><label for='data-ef756f4f-0fe7-4d74-9e70-5a6e1ed0bc74' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>[110376 values with dtype=float64]</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-78574f7f-ca1e-48fa-9d05-755cf8e39fe9' class='xr-section-summary-in' type='checkbox'  ><label for='section-78574f7f-ca1e-48fa-9d05-755cf8e39fe9' class='xr-section-summary' >Indexes: <span>(2)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-index-name'><div>station</div></div><div class='xr-index-preview'>PandasIndex</div><input type='checkbox' disabled/><label></label><input id='index-7ccaac1b-f62a-49f8-af99-ef5dc0af95ca' class='xr-index-data-in' type='checkbox'/><label for='index-7ccaac1b-f62a-49f8-af99-ef5dc0af95ca' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Index([&#x27;AGO Site&#x27;, &#x27;AGO-4&#x27;, &#x27;AGO-5&#x27;, &#x27;AGO-A81&#x27;, &#x27;AWS18&#x27;, &#x27;AWS19&#x27;,
       &#x27;Alexander (TT!)&#x27;, &#x27;Allison&#x27;, &#x27;AmeryG3&#x27;, &#x27;Arelis&#x27;,
       ...
       &#x27;aws08&#x27;, &#x27;aws09&#x27;, &#x27;aws10&#x27;, &#x27;aws11&#x27;, &#x27;aws12&#x27;, &#x27;aws13&#x27;, &#x27;aws14&#x27;, &#x27;aws15&#x27;,
       &#x27;aws16&#x27;, &#x27;aws17&#x27;],
      dtype=&#x27;object&#x27;, name=&#x27;station&#x27;, length=219))</pre></div></li><li class='xr-var-item'><div class='xr-index-name'><div>t</div></div><div class='xr-index-preview'>PandasIndex</div><input type='checkbox' disabled/><label></label><input id='index-75a34dd4-d6bf-4d48-949c-c760cb3571e0' class='xr-index-data-in' type='checkbox'/><label for='index-75a34dd4-d6bf-4d48-949c-c760cb3571e0' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Index([  1.0,   2.0,   3.0,   4.0,   5.0,   6.0,   7.0,   8.0,   9.0,  10.0,
       ...
       495.0, 496.0, 497.0, 498.0, 499.0, 500.0, 501.0, 502.0, 503.0, 504.0],
      dtype=&#x27;float64&#x27;, name=&#x27;t&#x27;, length=504))</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-00262dfc-7fe4-4385-8c21-e3f27dcc23a9' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-00262dfc-7fe4-4385-8c21-e3f27dcc23a9' class='xr-section-summary'  title='Expand/collapse section'>Attributes: <span>(0)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><dl class='xr-attrs'></dl></div></li></ul></div></div></div></div>
</details>
</div>
<div class="cell tag_hide-output docutils container">
<div class="cell_input above-output-prompt docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Displaying the climate model data</span>
<span class="n">ds_climate</span>
</pre></div>
</div>
</div>
<details class="hide below-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell output</span>
<span class="expanded">Hide code cell output</span>
</summary>
<div class="cell_output docutils container">
<div class="output text_html"><div><svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewBox="0 0 32 32">
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewBox="0 0 32 32">
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme="dark"],
html[data-theme="dark"],
body[data-theme="dark"],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1f1f1f;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block !important;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 0 20px 0 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: inline-block;
  opacity: 0;
  height: 0;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:focus + label {
  border: 2px solid var(--xr-font-color0);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: "►";
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: "▼";
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: "(";
}

.xr-dim-list:after {
  content: ")";
}

.xr-dim-list li:not(:last-child):after {
  content: ",";
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-index-preview {
  grid-column: 2 / 5;
  color: var(--xr-font-color2);
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data,
.xr-index-data-in:checked ~ .xr-index-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-index-name div,
.xr-index-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2,
.xr-no-icon {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style><pre class='xr-text-repr-fallback'>&lt;xarray.Dataset&gt; Size: 45MB
Dimensions:         (time: 456, grid_longitude: 126, grid_latitude: 98)
Coordinates:
  * grid_longitude  (grid_longitude) float64 1kB 152.4 152.9 ... 207.0 207.4
  * grid_latitude   (grid_latitude) float64 784B -21.39 -20.95 ... 20.84 21.29
  * time            (time) datetime64[ns] 4kB 1981-01-31 ... 2018-12-31
    month           (time) int64 4kB ...
    year            (time) int64 4kB ...
    glon            (grid_longitude, grid_latitude) float64 99kB ...
    glat            (grid_longitude, grid_latitude) float64 99kB ...
    t               (time) int64 4kB ...
Data variables:
    temperature     (time, grid_longitude, grid_latitude) float64 45MB ...
    elevation       (grid_longitude, grid_latitude) float64 99kB ...
    latitude        (grid_longitude, grid_latitude) float64 99kB ...</pre><div class='xr-wrap' style='display:none'><div class='xr-header'><div class='xr-obj-type'>xarray.Dataset</div></div><ul class='xr-sections'><li class='xr-section-item'><input id='section-116317b8-4a09-4948-93cf-c27494745dba' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-116317b8-4a09-4948-93cf-c27494745dba' class='xr-section-summary'  title='Expand/collapse section'>Dimensions:</label><div class='xr-section-inline-details'><ul class='xr-dim-list'><li><span class='xr-has-index'>time</span>: 456</li><li><span class='xr-has-index'>grid_longitude</span>: 126</li><li><span class='xr-has-index'>grid_latitude</span>: 98</li></ul></div><div class='xr-section-details'></div></li><li class='xr-section-item'><input id='section-f55a9836-9fd8-4f44-97f5-771455d7a6d8' class='xr-section-summary-in' type='checkbox'  checked><label for='section-f55a9836-9fd8-4f44-97f5-771455d7a6d8' class='xr-section-summary' >Coordinates: <span>(8)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>grid_longitude</span></div><div class='xr-var-dims'>(grid_longitude)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>152.4 152.9 153.3 ... 207.0 207.4</div><input id='attrs-151b98d9-b790-4a0d-be10-d8553deda646' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-151b98d9-b790-4a0d-be10-d8553deda646' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-4d116a1f-9921-401d-8528-5d80abe6e5f7' class='xr-var-data-in' type='checkbox'><label for='data-4d116a1f-9921-401d-8528-5d80abe6e5f7' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([152.445   , 152.885002, 153.325005, 153.764996, 154.204994, 154.644997,
       155.084999, 155.525002, 155.965004, 156.404999, 156.844994, 157.284996,
       157.724998, 158.165001, 158.605003, 159.045002, 159.484993, 159.924995,
       160.364998, 160.805   , 161.245003, 161.685005, 162.124996, 162.564995,
       163.004997, 163.445   , 163.885002, 164.325005, 164.764999, 165.204994,
       165.644997, 166.084999, 166.525002, 166.965004, 167.405006, 167.844994,
       168.284996, 168.724998, 169.165001, 169.605003, 170.045002, 170.484997,
       170.924995, 171.364998, 171.805   , 172.245003, 172.685005, 173.125004,
       173.564995, 174.004997, 174.445   , 174.885002, 175.325005, 175.765003,
       176.204998, 176.644997, 177.084999, 177.525002, 177.965004, 178.405006,
       178.844997, 179.284996, 179.724998, 180.165001, 180.605003, 181.045006,
       181.485001, 181.924995, 182.364998, 182.805   , 183.245003, 183.685005,
       184.125004, 184.564999, 185.004997, 185.445   , 185.885002, 186.325005,
       186.764999, 187.205002, 187.644997, 188.084999, 188.525002, 188.965004,
       189.405006, 189.845001, 190.284996, 190.724998, 191.165001, 191.605003,
       192.045006, 192.485001, 192.924999, 193.364998, 193.805   , 194.245003,
       194.685005, 195.125004, 195.565002, 196.004997, 196.445   , 196.885002,
       197.325005, 197.765003, 198.205002, 198.645   , 199.084999, 199.525002,
       199.965004, 200.405006, 200.845001, 201.285   , 201.724998, 202.165001,
       202.605003, 203.045006, 203.485001, 203.925003, 204.364998, 204.805   ,
       205.245003, 205.685005, 206.125004, 206.565002, 207.004997, 207.445   ])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>grid_latitude</span></div><div class='xr-var-dims'>(grid_latitude)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>-21.39 -20.95 ... 20.84 21.29</div><input id='attrs-1450ef42-4515-4089-8294-a843dc0f846d' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-1450ef42-4515-4089-8294-a843dc0f846d' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-13da3e1b-8096-4e77-840a-17b72899e0fa' class='xr-var-data-in' type='checkbox'><label for='data-13da3e1b-8096-4e77-840a-17b72899e0fa' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([-21.395   , -20.954999, -20.514999, -20.075   , -19.634999, -19.194999,
       -18.755   , -18.315   , -17.875   , -17.434999, -16.994999, -16.555   ,
       -16.114999, -15.674999, -15.234999, -14.794999, -14.355   , -13.915   ,
       -13.474999, -13.035   , -12.595   , -12.154999, -11.714999, -11.275   ,
       -10.835   , -10.395   ,  -9.955   ,  -9.514999,  -9.075   ,  -8.635   ,
        -8.195   ,  -7.754999,  -7.315   ,  -6.875   ,  -6.434999,  -5.995   ,
        -5.555   ,  -5.114999,  -4.675   ,  -4.235   ,  -3.795   ,  -3.355   ,
        -2.914999,  -2.474999,  -2.034999,  -1.595   ,  -1.155   ,  -0.715   ,
        -0.275   ,   0.165   ,   0.605   ,   1.045001,   1.485   ,   1.925   ,
         2.365   ,   2.805001,   3.245   ,   3.685   ,   4.125   ,   4.565   ,
         5.005   ,   5.445001,   5.885001,   6.325   ,   6.765   ,   7.205   ,
         7.645   ,   8.085001,   8.525001,   8.965001,   9.405   ,   9.845   ,
        10.285   ,  10.725   ,  11.165   ,  11.605   ,  12.045   ,  12.485001,
        12.925001,  13.365   ,  13.805   ,  14.245001,  14.684999,  15.125001,
        15.565001,  16.005   ,  16.445001,  16.885   ,  17.325   ,  17.765001,
        18.205   ,  18.645   ,  19.085001,  19.525   ,  19.965   ,  20.405001,
        20.844999,  21.285001])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>time</span></div><div class='xr-var-dims'>(time)</div><div class='xr-var-dtype'>datetime64[ns]</div><div class='xr-var-preview xr-preview'>1981-01-31 ... 2018-12-31</div><input id='attrs-562fc27b-5096-46f9-b471-37a003c19b4f' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-562fc27b-5096-46f9-b471-37a003c19b4f' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-c2ec8d8b-248a-4e7f-b59c-eb5c649e7791' class='xr-var-data-in' type='checkbox'><label for='data-c2ec8d8b-248a-4e7f-b59c-eb5c649e7791' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([&#x27;1981-01-31T00:00:00.000000000&#x27;, &#x27;1981-02-28T00:00:00.000000000&#x27;,
       &#x27;1981-03-31T00:00:00.000000000&#x27;, ..., &#x27;2018-10-31T00:00:00.000000000&#x27;,
       &#x27;2018-11-30T00:00:00.000000000&#x27;, &#x27;2018-12-31T00:00:00.000000000&#x27;],
      shape=(456,), dtype=&#x27;datetime64[ns]&#x27;)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>month</span></div><div class='xr-var-dims'>(time)</div><div class='xr-var-dtype'>int64</div><div class='xr-var-preview xr-preview'>...</div><input id='attrs-78509867-ad76-4ed4-aa6b-a0999cd9175f' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-78509867-ad76-4ed4-aa6b-a0999cd9175f' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-8457d5c2-b85a-4a76-9b8f-dfac461cc704' class='xr-var-data-in' type='checkbox'><label for='data-8457d5c2-b85a-4a76-9b8f-dfac461cc704' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>[456 values with dtype=int64]</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>year</span></div><div class='xr-var-dims'>(time)</div><div class='xr-var-dtype'>int64</div><div class='xr-var-preview xr-preview'>...</div><input id='attrs-8c1b923d-ed1c-47b3-bed4-861276f5d5be' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-8c1b923d-ed1c-47b3-bed4-861276f5d5be' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-199ac97b-30d7-412a-8b03-46c4e3a6da91' class='xr-var-data-in' type='checkbox'><label for='data-199ac97b-30d7-412a-8b03-46c4e3a6da91' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>[456 values with dtype=int64]</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>glon</span></div><div class='xr-var-dims'>(grid_longitude, grid_latitude)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>...</div><input id='attrs-5949e4a4-4501-4b60-a22e-07c99dc21e8d' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-5949e4a4-4501-4b60-a22e-07c99dc21e8d' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-7a8f4e21-d330-4dac-8ee8-753aea36409d' class='xr-var-data-in' type='checkbox'><label for='data-7a8f4e21-d330-4dac-8ee8-753aea36409d' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>[12348 values with dtype=float64]</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>glat</span></div><div class='xr-var-dims'>(grid_longitude, grid_latitude)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>...</div><input id='attrs-1f09e374-360a-41c0-8a10-49d446483931' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-1f09e374-360a-41c0-8a10-49d446483931' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-231958ad-86ee-4c21-87fe-1a7299f87a68' class='xr-var-data-in' type='checkbox'><label for='data-231958ad-86ee-4c21-87fe-1a7299f87a68' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>[12348 values with dtype=float64]</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>t</span></div><div class='xr-var-dims'>(time)</div><div class='xr-var-dtype'>int64</div><div class='xr-var-preview xr-preview'>...</div><input id='attrs-bb5663db-dcd8-42d5-8148-81617d4147ce' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-bb5663db-dcd8-42d5-8148-81617d4147ce' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-473e2041-401a-4719-97c4-3fdb608bd4b8' class='xr-var-data-in' type='checkbox'><label for='data-473e2041-401a-4719-97c4-3fdb608bd4b8' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>[456 values with dtype=int64]</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-f79f2974-ab1e-4312-93bb-ea63049c3166' class='xr-section-summary-in' type='checkbox'  checked><label for='section-f79f2974-ab1e-4312-93bb-ea63049c3166' class='xr-section-summary' >Data variables: <span>(3)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span>temperature</span></div><div class='xr-var-dims'>(time, grid_longitude, grid_latitude)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>...</div><input id='attrs-d1faab43-3839-4dc9-8298-d156df190b55' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-d1faab43-3839-4dc9-8298-d156df190b55' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-9273640a-47ed-4aec-bfbb-42ab0abfe1a0' class='xr-var-data-in' type='checkbox'><label for='data-9273640a-47ed-4aec-bfbb-42ab0abfe1a0' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>[5630688 values with dtype=float64]</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>elevation</span></div><div class='xr-var-dims'>(grid_longitude, grid_latitude)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>...</div><input id='attrs-8c94dc2c-fed2-427b-b214-0483c82e3a8a' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-8c94dc2c-fed2-427b-b214-0483c82e3a8a' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-a2bd4fcd-1301-4a91-b58f-1f7870a1b5d9' class='xr-var-data-in' type='checkbox'><label for='data-a2bd4fcd-1301-4a91-b58f-1f7870a1b5d9' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>[12348 values with dtype=float64]</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>latitude</span></div><div class='xr-var-dims'>(grid_longitude, grid_latitude)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>...</div><input id='attrs-4925f5b9-f010-4351-bdc2-37159e3d6242' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-4925f5b9-f010-4351-bdc2-37159e3d6242' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-a3d20ab5-84bd-49f8-96a5-3a22890423bb' class='xr-var-data-in' type='checkbox'><label for='data-a3d20ab5-84bd-49f8-96a5-3a22890423bb' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>[12348 values with dtype=float64]</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-10c05e87-6ba9-48d6-9172-f9936ca1b591' class='xr-section-summary-in' type='checkbox'  ><label for='section-10c05e87-6ba9-48d6-9172-f9936ca1b591' class='xr-section-summary' >Indexes: <span>(3)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-index-name'><div>grid_longitude</div></div><div class='xr-index-preview'>PandasIndex</div><input type='checkbox' disabled/><label></label><input id='index-6b5cc03e-d118-497d-b516-08fe4b65ce27' class='xr-index-data-in' type='checkbox'/><label for='index-6b5cc03e-d118-497d-b516-08fe4b65ce27' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Index([152.44499969482422, 152.88500213623047, 153.32500457763672,
       153.76499557495117, 154.20499420166016,  154.6449966430664,
       155.08499908447266,  155.5250015258789, 155.96500396728516,
       156.40499877929688,
       ...
       203.48500061035156,  203.9250030517578, 204.36499786376953,
       204.80500030517578, 205.24500274658203, 205.68500518798828,
       206.12500381469727, 206.56500244140625, 207.00499725341797,
       207.44499969482422],
      dtype=&#x27;float64&#x27;, name=&#x27;grid_longitude&#x27;, length=126))</pre></div></li><li class='xr-var-item'><div class='xr-index-name'><div>grid_latitude</div></div><div class='xr-index-preview'>PandasIndex</div><input type='checkbox' disabled/><label></label><input id='index-53bee857-bed2-43e8-962b-97190c6486ff' class='xr-index-data-in' type='checkbox'/><label for='index-53bee857-bed2-43e8-962b-97190c6486ff' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Index([ -21.394999504089355,  -20.954999446868896,  -20.514999389648438,
        -20.074999809265137,   -19.63499927520752,   -19.19499921798706,
         -18.75499963760376,    -18.3149995803833,  -17.874999523162842,
        -17.434999465942383,  -16.994999408721924,  -16.554999828338623,
        -16.114999294281006,  -15.674999475479126,  -15.234999418258667,
        -14.794999361038208,  -14.354999542236328,  -13.914999723434448,
         -13.47499942779541,   -13.03499960899353,  -12.594999551773071,
        -12.154999494552612,  -11.714999437332153,  -11.274999618530273,
        -10.834999561309814,  -10.394999504089355,   -9.954999685287476,
         -9.514999389648438,   -9.074999570846558,   -8.634999513626099,
         -8.194999694824219,   -7.754999399185181,   -7.314999580383301,
         -6.874999523162842,   -6.434999465942383,   -5.994999647140503,
         -5.554999589920044,   -5.114999294281006,   -4.674999713897705,
         -4.234999656677246,   -3.794999599456787,   -3.354999542236328,
         -2.914999485015869,    -2.47499942779541,   -2.034999370574951,
        -1.5949997901916504,  -1.1549997329711914,  -0.7149996757507324,
       -0.27499961853027344,  0.16500043869018555,   0.6050004959106445,
         1.0450005531311035,   1.4850001335144043,   1.9250001907348633,
         2.3650002479553223,   2.8050007820129395,   3.2450003623962402,
          3.685000419616699,    4.125000476837158,    4.565000057220459,
          5.005000114440918,    5.445000648498535,    5.885000705718994,
          6.325000286102295,    6.765000343322754,    7.205000400543213,
          7.644999980926514,     8.08500051498413,     8.52500057220459,
          8.965000629425049,     9.40500020980835,    9.845000267028809,
          10.28499984741211,   10.725000381469727,   11.164999961853027,
         11.605000495910645,   12.045000076293945,   12.485000610351562,
          12.92500114440918,   13.364999771118164,   13.805000305175781,
         14.245000839233398,   14.684999465942383,   15.125000953674316,
         15.565000534057617,   16.005000114440918,   16.445000648498535,
         16.885000228881836,   17.324999809265137,    17.76500129699707,
         18.204999923706055,   18.645000457763672,    19.08500099182129,
         19.524999618530273,    19.96500015258789,   20.405000686645508,
         20.844999313354492,   21.285000801086426],
      dtype=&#x27;float64&#x27;, name=&#x27;grid_latitude&#x27;))</pre></div></li><li class='xr-var-item'><div class='xr-index-name'><div>time</div></div><div class='xr-index-preview'>PandasIndex</div><input type='checkbox' disabled/><label></label><input id='index-89169537-ca09-42b6-a726-c59f78e1d87c' class='xr-index-data-in' type='checkbox'/><label for='index-89169537-ca09-42b6-a726-c59f78e1d87c' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(DatetimeIndex([&#x27;1981-01-31&#x27;, &#x27;1981-02-28&#x27;, &#x27;1981-03-31&#x27;, &#x27;1981-04-30&#x27;,
               &#x27;1981-05-31&#x27;, &#x27;1981-06-30&#x27;, &#x27;1981-07-31&#x27;, &#x27;1981-08-31&#x27;,
               &#x27;1981-09-30&#x27;, &#x27;1981-10-31&#x27;,
               ...
               &#x27;2018-03-31&#x27;, &#x27;2018-04-30&#x27;, &#x27;2018-05-31&#x27;, &#x27;2018-06-30&#x27;,
               &#x27;2018-07-31&#x27;, &#x27;2018-08-31&#x27;, &#x27;2018-09-30&#x27;, &#x27;2018-10-31&#x27;,
               &#x27;2018-11-30&#x27;, &#x27;2018-12-31&#x27;],
              dtype=&#x27;datetime64[ns]&#x27;, name=&#x27;time&#x27;, length=456, freq=None))</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-0827ea02-8728-4efb-bfff-5955de433ea7' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-0827ea02-8728-4efb-bfff-5955de433ea7' class='xr-section-summary'  title='Expand/collapse section'>Attributes: <span>(0)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><dl class='xr-attrs'></dl></div></li></ul></div></div></div></div>
</details>
</div>
<div class="cell tag_hide-output docutils container">
<div class="cell_input above-output-prompt docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Computing basic summary statistics using the pandas port of xarray objects</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Summary of Automatic Weather Station Data </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
      <span class="n">ds_aws</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">describe</span><span class="p">()[[</span><span class="s1">&#39;elevation&#39;</span><span class="p">,</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span><span class="s1">&#39;temperature&#39;</span><span class="p">]])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Summary of Climate Model Data </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
      <span class="n">ds_climate</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">describe</span><span class="p">()[[</span><span class="s1">&#39;elevation&#39;</span><span class="p">,</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span><span class="s1">&#39;temperature&#39;</span><span class="p">]])</span>
</pre></div>
</div>
</div>
<details class="hide below-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell output</span>
<span class="expanded">Hide code cell output</span>
</summary>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Summary of Automatic Weather Station Data 
            elevation       latitude   temperature
count  110376.000000  110376.000000  18088.000000
mean     1251.009132     -76.472009    -25.852952
std      1131.183380       5.411963     14.071861
min         5.000000     -90.000000    -71.740000
25%        87.000000     -79.820000    -31.880000
50%      1122.000000     -76.320000    -24.135000
75%      2090.000000     -73.080000    -16.320000
max      4093.000000     -65.240000      1.750000

 Summary of Climate Model Data 
           elevation      latitude   temperature
count  2.610144e+06  2.610144e+06  2.610144e+06
mean   2.003590e+03 -7.661032e+01 -3.257423e+01
std    1.150357e+03  5.392458e+00  1.458319e+01
min   -3.087963e+00 -8.971554e+01 -7.326862e+01
25%    1.045115e+03 -8.060204e+01 -4.373946e+01
50%    2.192235e+03 -7.646343e+01 -3.125523e+01
75%    2.988649e+03 -7.229835e+01 -2.182017e+01
max    4.063502e+03 -6.397399e+01  1.437534e+00
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="data-exploration">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">Data Exploration</a><a class="headerlink" href="#data-exploration" title="Link to this heading">#</a></h2>
<p>Initial data exploration is essential for informing our model construction. It includes examining the spatial and temporal distributions of the data and relationships between variables and potential predictors. To start we’ll examine the spatial distribution of weather stations, plotting over the grid of the climate model.</p>
<section id="spatial-distribution-of-weather-stations">
<h3><a class="toc-backref" href="#id4" role="doc-backlink">Spatial Distribution of Weather Stations</a><a class="headerlink" href="#spatial-distribution-of-weather-stations" title="Link to this heading">#</a></h3>
<div class="note dropdown admonition">
<p class="admonition-title">Coordinate Systems:</p>
<p>Note that for plotting we use a specific rotated coordinate system (defined below). The ‘glon’ and ‘glat’ fields are in this coordinate system and it was created to get around issues assoicated with plotting the shapefile when the longitude flips between -180 to 180.</p>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Loading ice sheet shapefile </span>
<span class="n">icesheet_shapefile_path</span> <span class="o">=</span> <span class="s1">&#39;/home/jez/Bias_Correction_Application/walkthrough_tutorial/tutorial_data/icesheet_shapefile/icesheet.shp&#39;</span>
<span class="n">gdf_icesheet</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">icesheet_shapefile_path</span><span class="p">)</span>

<span class="c1"># Defining rotated coordinate system (glon,glat) and converting ice sheet shapefile to rotated coordinates</span>
<span class="n">rotated_coord_system</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">RotatedGeodetic</span><span class="p">(</span>
    <span class="mf">13.079999923706055</span><span class="p">,</span>
    <span class="mf">0.5199999809265137</span><span class="p">,</span>
    <span class="n">central_rotated_longitude</span><span class="o">=</span><span class="mf">180.0</span><span class="p">,</span>
    <span class="n">globe</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">gdf_icesheet_rotatedcoords</span> <span class="o">=</span> <span class="n">gdf_icesheet</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">rotated_coord_system</span><span class="p">)</span>

<span class="c1">############################################################################################################</span>

<span class="c1"># Defining background map function</span>
<span class="k">def</span> <span class="nf">background_map_rotatedcoords</span><span class="p">(</span><span class="n">ax</span><span class="p">):</span>
    <span class="n">gdf_icesheet_rotatedcoords</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>

<span class="c1"># Defining marker size legend function</span>
<span class="k">def</span> <span class="nf">markersize_legend</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">scale_multipler</span><span class="p">,</span> <span class="n">legend_fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">loc</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">columnspacing</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">handletextpad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">bbox</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">)):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
            <span class="n">handles</span><span class="o">=</span><span class="p">[</span>
                <span class="n">mlines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">(</span>
                    <span class="p">[],</span>
                    <span class="p">[],</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:blue&quot;</span><span class="p">,</span>
                    <span class="n">markeredgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
                    <span class="n">markeredgewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                    <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
                    <span class="n">markersize</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="n">scale_multipler</span><span class="p">),</span>
                    <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="p">)),</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span>
            <span class="n">fontsize</span> <span class="o">=</span> <span class="n">legend_fontsize</span><span class="p">,</span>
            <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
            <span class="n">columnspacing</span><span class="o">=</span><span class="n">columnspacing</span><span class="p">,</span>
            <span class="n">handletextpad</span><span class="o">=</span><span class="n">handletextpad</span><span class="p">,</span>
            <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="n">bbox</span><span class="p">,</span>
            <span class="n">framealpha</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

<span class="c1">############################################################################################################</span>

<span class="c1"># Plotting the weather station locations</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span><span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span><span class="c1">#,frameon=False)</span>
<span class="n">background_map_rotatedcoords</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">ds_aws</span><span class="o">.</span><span class="n">glon</span><span class="p">,</span>
    <span class="n">ds_aws</span><span class="o">.</span><span class="n">glat</span><span class="p">,</span>
    <span class="n">s</span><span class="o">=</span><span class="n">ds_aws</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
    <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
    <span class="s1">&#39;Number of records:&#39;</span><span class="p">,</span>
    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.08</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">,</span>
    <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">markersize_legend</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">300</span><span class="p">,</span><span class="mi">400</span><span class="p">],</span> <span class="n">scale_multipler</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">5</span><span class="p">,</span> <span class="n">legend_fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">loc</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">ncols</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">columnspacing</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span><span class="n">handletextpad</span><span class="o">=-</span><span class="mf">0.4</span><span class="p">,</span><span class="n">bbox</span><span class="o">=</span><span class="p">(</span><span class="mf">0.08</span><span class="p">,</span><span class="mf">0.05</span><span class="p">))</span>

<span class="c1"># highlighting individual station</span>
<span class="n">station</span> <span class="o">=</span> <span class="s1">&#39;Manuela&#39;</span>
<span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">station</span><span class="si">}</span><span class="s1"> Weather Station&#39;</span><span class="p">,</span>
    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">ds_aws</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">station</span> <span class="o">=</span> <span class="n">station</span><span class="p">)</span><span class="o">.</span><span class="n">glon</span><span class="p">,</span> <span class="n">ds_aws</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">station</span> <span class="o">=</span> <span class="n">station</span><span class="p">)</span><span class="o">.</span><span class="n">glat</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
    <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">140</span><span class="p">,</span><span class="o">-</span><span class="mi">15</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span>
    <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&gt;&quot;</span><span class="p">),</span>
    <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># Plotting the climate model grid</span>
<span class="n">ds_climate</span><span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="s1">&#39;glon&#39;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s1">&#39;glat&#39;</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
    <span class="n">add_colorbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ERROR 1: PROJ: proj_create_from_database: Open of /home/jez/miniconda3/envs/jbook_BCA/share/proj failed
</pre></div>
</div>
<img alt="../../../_images/d0d61b06a27b71f0edc8a69ed579492857322fb24fa29400f26147b252b3be2d.png" src="../../../_images/d0d61b06a27b71f0edc8a69ed579492857322fb24fa29400f26147b252b3be2d.png" />
</div>
</div>
<p>It is clear that the spatial distribution of weather stations is not uniform over the domain. There are certain regions containing high-density clusters of stations. This will induce a bias in the bias-correction itself when conducted over the whole domain, with corrections skewed towards these regions. If these clusters occured randomly then modelling the spatial correlation between sites would be adequate to account for the distribution. Instead it is likely these regions were chosen for specific features, such as having anomalously high temperatures, which is difficult to account for in the model. We don’t directly attempt to solve this problem but it is noted as a remaining limitation.</p>
</section>
<section id="time-series-and-distribution-of-single-weather-station-manuela">
<h3><a class="toc-backref" href="#id5" role="doc-backlink">Time Series and Distribution of Single Weather Station (Manuela)</a><a class="headerlink" href="#time-series-and-distribution-of-single-weather-station-manuela" title="Link to this heading">#</a></h3>
<p>Comparisons are made between the time series for the Manuela weather station and the nearest grid-cell of the climate model output. The time series represents the average temperature for each month and the values are aggregated from hourly measurements of the raw data (preprocessed in this notebook for simplicity).</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Computing Nearest Neighbours</span>
<span class="n">ds_climate_stacked</span> <span class="o">=</span> <span class="n">ds_climate</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;grid_longitude&#39;</span><span class="p">,</span> <span class="s1">&#39;grid_latitude&#39;</span><span class="p">))</span>
<span class="n">ds_climate_stacked_landonly</span> <span class="o">=</span> <span class="n">ds_climate_stacked</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="n">ox</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">([</span><span class="n">ds_aws</span><span class="p">[</span><span class="s1">&#39;glon&#39;</span><span class="p">],</span><span class="n">ds_aws</span><span class="p">[</span><span class="s1">&#39;glat&#39;</span><span class="p">]])[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">cx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">([</span><span class="n">ds_climate_stacked_landonly</span><span class="p">[</span><span class="s1">&#39;glon&#39;</span><span class="p">],</span><span class="n">ds_climate_stacked_landonly</span><span class="p">[</span><span class="s1">&#39;glat&#39;</span><span class="p">]])[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">nn_indecies</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">ox</span><span class="p">:</span>
    <span class="n">nn_indecies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">distance</span><span class="o">.</span><span class="n">cdist</span><span class="p">([</span><span class="n">point</span><span class="p">],</span> <span class="n">cx</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">())</span>
<span class="n">ds_climate_nearest_stacked</span> <span class="o">=</span> <span class="n">ds_climate_stacked_landonly</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">nn_indecies</span><span class="p">)</span>
<span class="n">ds_climate_nearest_stacked</span> <span class="o">=</span> <span class="n">ds_climate_nearest_stacked</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">nearest_station</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">ds_aws</span><span class="o">.</span><span class="n">station</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
<span class="n">ds_climate_nearest_stacked</span> <span class="o">=</span> <span class="n">ds_climate_nearest_stacked</span><span class="o">.</span><span class="n">swap_dims</span><span class="p">({</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="s2">&quot;nearest_station&quot;</span><span class="p">})</span>

<span class="c1"># Single Site Full Time Series</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">station</span> <span class="o">=</span> <span class="s1">&#39;Manuela&#39;</span>
<span class="n">ds_climate_nearest_stacked</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">nearest_station</span> <span class="o">=</span> <span class="n">station</span><span class="p">)[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;t&quot;</span><span class="p">,</span>
                                                                              <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                                                                              <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;station&#39;</span><span class="p">,</span>
                                                                              <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                                                                              <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Climate Model Output (Nearest Grid-Cell)&#39;</span><span class="p">,</span>
                                                                              <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
                                                                              <span class="n">ms</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                              <span class="n">color</span><span class="o">=</span><span class="s1">&#39;tab:blue&#39;</span><span class="p">,</span>
                                                                              <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

<span class="n">ds_aws</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">station</span> <span class="o">=</span> <span class="n">station</span><span class="p">)[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                                                <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;station&#39;</span><span class="p">,</span>
                                                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                                                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">station</span><span class="si">}</span><span class="s1"> Weather Station&#39;</span><span class="p">,</span>
                                                <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
                                                <span class="n">ms</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;tab:orange&#39;</span><span class="p">,</span>
                                                <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">xticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">45</span><span class="o">*</span><span class="mi">12</span><span class="p">,</span><span class="mi">12</span><span class="o">*</span><span class="mi">5</span><span class="p">)</span>
<span class="n">xticklabels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1980</span><span class="p">,</span><span class="mi">2025</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">xticks</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">xticklabels</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Temperature&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../../../_images/e1a551ba2eb37c5b32266f02401fac98c2652f18f759e69a828c40fe3f1b2942.png" src="../../../_images/e1a551ba2eb37c5b32266f02401fac98c2652f18f759e69a828c40fe3f1b2942.png" />
</div>
</div>
<p>The Manuela weather station has one of the highest number of temperature records, spanning from 1984-2021. The time series for the climate model spans 1981-2019. It’s clear that the variance in the time series are dominated by the seasonal cycle and that any bias in for example the mean will have some seasonal dependency. The PDFs for the 2 time series are plot below.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Probability Density Function (all months)</span>
<span class="n">station</span> <span class="o">=</span> <span class="s1">&#39;Manuela&#39;</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">ds_aws</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">station</span><span class="o">=</span><span class="n">station</span><span class="p">)</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()[[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
                                         <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                                         <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                                         <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                                         <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                         <span class="n">density</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                         <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                                         <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">station</span><span class="si">}</span><span class="s1"> Weather Station&#39;</span><span class="p">,</span>
                                         <span class="p">)</span>
<span class="n">ds_climate_nearest_stacked</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">nearest_station</span><span class="o">=</span><span class="n">station</span><span class="p">)</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()[[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
                                         <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                                         <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                                         <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                                         <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                         <span class="n">density</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                         <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                                        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Climate Model Output (Nearest Grid-Cell)&#39;</span><span class="p">,</span>
                                         <span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;All Months&#39;</span><span class="p">,</span><span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.03</span><span class="p">,</span><span class="mf">0.95</span><span class="p">),</span><span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Temperature&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../../../_images/aecf1a08ffbd13d72d03c8aca963553cc9c01d592b26c8cf1da1374108eb64bc.png" src="../../../_images/aecf1a08ffbd13d72d03c8aca963553cc9c01d592b26c8cf1da1374108eb64bc.png" />
</div>
</div>
<p>In this tutorial we define bias with respect to differences between the parameters that describe the PDFs of the time series. The PDF above is multi-modal, reflecting the seasonality of the data, meaning we’d need to use quite a few parameters to adequately describe the distribution. Simply using the mean would have limited value as we can see that the winter peak is ~5° higher for the climate model output while the summer peaks are approximately equal. The common approach here is to simply split the time series up by the month, focusing on defining bias for each month separately. The PDFs for individual months are approximately Gaussian (see below) and so the bias can be defined in terms of differences in the mean and variance parameters between the datasets.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Probability Density Function by Month</span>
<span class="n">station</span> <span class="o">=</span> <span class="s1">&#39;Manuela&#39;</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">ds_aws</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">station</span><span class="o">=</span><span class="n">station</span><span class="p">)</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()[[</span><span class="s1">&#39;month&#39;</span><span class="p">,</span><span class="s1">&#39;temperature&#39;</span><span class="p">]],</span>
            <span class="n">x</span><span class="o">=</span><span class="s1">&#39;temperature&#39;</span><span class="p">,</span>
            <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;month&#39;</span><span class="p">,</span>
            <span class="n">bins</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
            <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
            <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;Paired&#39;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Temperature&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;January&#39;</span><span class="p">,</span><span class="s1">&#39;February&#39;</span><span class="p">,</span><span class="s1">&#39;March&#39;</span><span class="p">,</span><span class="s1">&#39;April&#39;</span><span class="p">,</span><span class="s1">&#39;May&#39;</span><span class="p">,</span><span class="s1">&#39;June&#39;</span><span class="p">,</span><span class="s1">&#39;July&#39;</span><span class="p">,</span><span class="s1">&#39;August&#39;</span><span class="p">,</span><span class="s1">&#39;September&#39;</span><span class="p">,</span><span class="s1">&#39;October&#39;</span><span class="p">,</span><span class="s1">&#39;November&#39;</span><span class="p">,</span><span class="s1">&#39;December&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../../../_images/652690496ce846f6512d7b0c3b318b2dc0a056ac13c6684ffb6b792a055d7220.png" src="../../../_images/652690496ce846f6512d7b0c3b318b2dc0a056ac13c6684ffb6b792a055d7220.png" />
</div>
</div>
<p>In this tutorial, we’ll focus on just applying bias correction to the monthly June time series, shown below for the Manuela station.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">month</span> <span class="o">=</span> <span class="mi">6</span> 
<span class="n">station</span> <span class="o">=</span> <span class="s1">&#39;Manuela&#39;</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ds_climate_nearest_stacked</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">nearest_station</span> <span class="o">=</span> <span class="n">station</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ds_climate_nearest_stacked</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">month</span><span class="p">,</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                                                                                                                                <span class="n">x</span><span class="o">=</span><span class="s1">&#39;t&#39;</span><span class="p">,</span>
                                                                                                                                <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                                                                                                                                <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;station&#39;</span><span class="p">,</span>
                                                                                                                                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                                                                                                                                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Climate Model Output (Nearest Grid-Cell)&#39;</span><span class="p">,</span>
                                                                                                                                <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
                                                                                                                                <span class="n">ms</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                                                                                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;tab:orange&#39;</span><span class="p">,</span>
                                                                                                                                <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="n">ds_aws</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">station</span> <span class="o">=</span> <span class="n">station</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ds_aws</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">month</span><span class="p">,</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                                                                                                <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;station&#39;</span><span class="p">,</span>
                                                                                                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                                                                                                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">station</span><span class="si">}</span><span class="s1"> Weather Station&#39;</span><span class="p">,</span>
                                                                                                <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
                                                                                                <span class="n">ms</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                                                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;tab:blue&#39;</span><span class="p">,</span>
                                                                                                <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;June&#39;</span><span class="p">,</span><span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.03</span><span class="p">,</span><span class="mf">0.95</span><span class="p">),</span><span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">xticks</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">xticklabels</span><span class="p">)</span><span class="c1">#,rotation = 90)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Temperature&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">ds_aws</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">station</span><span class="o">=</span><span class="n">station</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ds_aws</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">month</span><span class="p">,</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()[[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                                         <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                                         <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                                         <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                                         <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                         <span class="n">density</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                         <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                                         <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">station</span><span class="si">}</span><span class="s1"> Weather Station&#39;</span><span class="p">,</span>
                                         <span class="p">)</span>
<span class="n">ds_climate_nearest_stacked</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">nearest_station</span><span class="o">=</span><span class="n">station</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ds_climate_nearest_stacked</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">month</span><span class="p">,</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()[[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                                         <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                                         <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                                         <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                                         <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                         <span class="n">density</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                         <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                                        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Climate Model Output (Nearest Grid-Cell)&#39;</span><span class="p">,</span>
                                         <span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;June&#39;</span><span class="p">,</span><span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.03</span><span class="p">,</span><span class="mf">0.95</span><span class="p">),</span><span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Temperature&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../../../_images/efa6d5983cc4c3cd1a33fdf6ce666ce66a3d2f26ab667baffb111984bb9bf636.png" src="../../../_images/efa6d5983cc4c3cd1a33fdf6ce666ce66a3d2f26ab667baffb111984bb9bf636.png" />
</div>
</div>
<p>When examining the June time series, it’s clear that the climate model performs well at capturing the yearly variability and is highly correlated with the weather station output. However, there’s a significant bias in the mean of approximately 4°, indicating the utility of applying a bias correction.</p>
</section>
<section id="pairplots">
<h3><a class="toc-backref" href="#id6" role="doc-backlink">Pairplots</a><a class="headerlink" href="#pairplots" title="Link to this heading">#</a></h3>
<p>Since we’re interested in evaluating bias in the mean and variance of the June time series, it’s useful to think about predictors that have an influence on these metrics. The two most obvious predictors are elevation and latitude, both of which have well-understood physical justification for the impact on the mean temperature.</p>
<div class="note dropdown admonition">
<p class="admonition-title">Filtering AWS Data:</p>
<p>We filter to just June records as discussed above and also to only stations with more than 5 records. This limits the influence of uncertainty in the empirical estimates used for exploratory analysis.</p>
</div>
<div class="note dropdown admonition">
<p class="admonition-title">Nearest Grid Cells:</p>
<p>We’ve included a subcategory ‘Climate Model Nearest’ that represent values for just the climate model grid-cells nearest to each AWS. This is to get a feel for how representative the AWS samples are of Antarctic-wide region (e.g. it might be that differences between the datasets are just the result of the particular sample of locations with weather stations).</p>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Filtering to June only</span>
<span class="n">ds_aws_filtered</span> <span class="o">=</span> <span class="n">ds_aws</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">ds_aws</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">ds_climate_stacked_landonly_filtered</span> <span class="o">=</span> <span class="n">ds_climate_stacked_landonly</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="n">ds_climate_stacked_landonly</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">ds_climate_nearest_stacked_filtered</span> <span class="o">=</span> <span class="n">ds_climate_nearest_stacked</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="n">ds_climate_nearest_stacked</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>

<span class="c1"># Filtering AWS by number of records and updating nearest grid-cells to match</span>
<span class="n">ds_aws_filtered</span><span class="p">[</span><span class="s1">&#39;records&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds_aws_filtered</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span>
<span class="n">stations_recordsfilter</span> <span class="o">=</span> <span class="n">ds_aws_filtered</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ds_aws_filtered</span><span class="p">[</span><span class="s1">&#39;records&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">5</span><span class="p">,</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s1">&#39;station&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

<span class="n">ds_aws_filtered</span> <span class="o">=</span> <span class="n">ds_aws_filtered</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">station</span><span class="o">=</span><span class="n">stations_recordsfilter</span><span class="p">)</span>
<span class="n">ds_climate_nearest_stacked_filtered</span> <span class="o">=</span> <span class="n">ds_climate_nearest_stacked_filtered</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">nearest_station</span><span class="o">=</span><span class="n">stations_recordsfilter</span><span class="p">)</span>

<span class="c1"># Computing June Mean and Standard Deviation</span>
<span class="n">ds_aws_filtered</span><span class="p">[</span><span class="s1">&#39;june_mean_temperature&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds_aws_filtered</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span>
<span class="n">ds_aws_filtered</span><span class="p">[</span><span class="s1">&#39;june_std_temperature&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds_aws_filtered</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span>
<span class="n">ds_climate_stacked_landonly_filtered</span><span class="p">[</span><span class="s1">&#39;june_mean_temperature&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds_climate_stacked_landonly_filtered</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span>
<span class="n">ds_climate_stacked_landonly_filtered</span><span class="p">[</span><span class="s1">&#39;june_std_temperature&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds_climate_stacked_landonly_filtered</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span>
<span class="n">ds_climate_nearest_stacked_filtered</span><span class="p">[</span><span class="s1">&#39;june_mean_temperature&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds_climate_nearest_stacked_filtered</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span>
<span class="n">ds_climate_nearest_stacked_filtered</span><span class="p">[</span><span class="s1">&#39;june_std_temperature&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds_climate_nearest_stacked_filtered</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span>

<span class="c1"># Transforming data for plotting with seaborn PairGrid </span>
<span class="nb">vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;elevation&#39;</span><span class="p">,</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span><span class="s1">&#39;june_mean_temperature&#39;</span><span class="p">,</span><span class="s1">&#39;june_std_temperature&#39;</span><span class="p">]</span>
<span class="n">df_climate_filtered</span> <span class="o">=</span> <span class="n">ds_climate_stacked_landonly_filtered</span><span class="p">[</span><span class="nb">vars</span><span class="p">]</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()[</span><span class="nb">vars</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_climate_nearest_filtered</span> <span class="o">=</span> <span class="n">ds_climate_nearest_stacked_filtered</span><span class="p">[</span><span class="nb">vars</span><span class="p">]</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()[</span><span class="nb">vars</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_aws_filtered</span> <span class="o">=</span> <span class="n">ds_aws_filtered</span><span class="p">[</span><span class="nb">vars</span><span class="p">]</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()[</span><span class="nb">vars</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_climate_filtered</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Climate Model&#39;</span>
<span class="n">df_climate_nearest_filtered</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Climate Model Nearest&#39;</span>
<span class="n">df_aws_filtered</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;AWS&#39;</span>
<span class="n">df_combined</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_climate_filtered</span><span class="p">,</span><span class="n">df_climate_nearest_filtered</span><span class="p">,</span><span class="n">df_aws_filtered</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Plotting PairGrid with regression lines</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">PairGrid</span><span class="p">(</span><span class="n">df_combined</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;source&#39;</span><span class="p">,</span><span class="n">diag_sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">corner</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">reg_kws</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;scatter&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;line_kws&#39;</span><span class="p">:{</span><span class="s1">&#39;linewidth&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}}</span>
<span class="n">g</span><span class="o">.</span><span class="n">map_lower</span><span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">,</span><span class="o">**</span><span class="n">reg_kws</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">add_legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span><span class="mf">0.8</span><span class="p">),</span><span class="n">markerscale</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="n">g</span><span class="o">.</span><span class="n">hue_kws</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;marker&#39;</span><span class="p">:[</span><span class="s1">&#39;+&#39;</span><span class="p">,</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;*&#39;</span><span class="p">],</span><span class="s1">&#39;s&#39;</span><span class="p">:[</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="s1">&#39;alpha&#39;</span><span class="p">:[</span><span class="mf">0.2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]}</span>
<span class="n">scatter_kws</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;linewidth&#39;</span><span class="p">:</span><span class="mf">0.8</span><span class="p">}</span>
<span class="n">g</span><span class="o">.</span><span class="n">map_lower</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">,</span><span class="o">**</span><span class="n">scatter_kws</span><span class="p">)</span>

<span class="n">hist_kws</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;common_norm&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span><span class="s1">&#39;stat&#39;</span><span class="p">:</span><span class="s1">&#39;density&#39;</span><span class="p">}</span>
<span class="n">g</span><span class="o">.</span><span class="n">map_diag</span><span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">,</span><span class="o">**</span><span class="n">hist_kws</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../../../_images/aab62e17c054dd2f42ce6df6a01b72cc0fe209e38d4f49596701776edf34746b.png" src="../../../_images/aab62e17c054dd2f42ce6df6a01b72cc0fe209e38d4f49596701776edf34746b.png" />
</div>
</div>
<p>The pairplots bring up some interesting features:</p>
<ul class="simple">
<li><p>Comparisons of the histograms between the ‘Climate Model’ data (all grid-cells over Antarctica) and the ‘Climate Model Nearest’ data (only grid-cells closest to the weather stations) indicate that the AWS sites are not a particularly representative sample of the whole Antarctic region. There’s a higher proportion of sites at zero elevation, clusters of sites at particular locations (and so latitudes), disproportionality high numbers of sites at regions with relatively high mean temperatures and relatively low standard deviations.</p></li>
<li><p>There’s clear relationships between mean temperature with elevation and latitude. The slope of the linear relationship does not seem too strongly impacted by the particular subsample of AWS locations.</p></li>
<li><p>There’s only a weak relationship between the standard deviation in temperature with elevation and latitude. As a result we’ll leave out these predictors when estimating the standard deviation across the domain.</p></li>
<li><p>The behaviour of the relationship between elevation with mean temperature appears quite different at zero elevation sites, which could be linked with various factors such as the proximity and impact of the nearby sea on zero elevation sites. This potentially indicates at the utility of incorporating a distance to the coast predictor, although for this tutorial we leave this out.</p></li>
</ul>
</section>
<section id="examining-spatial-covariance-after-removing-influence-of-elevation-and-latitude">
<h3><a class="toc-backref" href="#id7" role="doc-backlink">Examining spatial covariance after removing influence of elevation and latitude</a><a class="headerlink" href="#examining-spatial-covariance-after-removing-influence-of-elevation-and-latitude" title="Link to this heading">#</a></h3>
<p>The spatial pattern in mean temperature is currently dominated by the relationship with elevation and latitude. While these are clearly important predictors for mean temperature, it’s expected that there’ll be various other important factors that impact mean temperature but are harder to account for (e.g. the funneling of wind down valleys will impact the mean temperature). One way of at least partially accounting for these factors is to model the spatial covariance between sites after removing the influence of elevation and latitude. That is that nearby sites are likely to be highly correlated as the factors impacting them are similar, whereas the further away you go the less correlated the sites will be (different valleys with different wind patterns etc).</p>
<p>Here we’ll plot the spatial pattern in the mean temperature after removing the linear influence of elevation and latitude. Additionally, we’ll plot the spatial pattern in the log of the standard deviation (taking the log to get the metric on the -<span class="math notranslate nohighlight">\(\infty,\infty\)</span> domain). Since the relationship between elevation and latitude with standard deviation appeared weak, we’ll ignore these predictors for this metric and simply remove a constant to get the zero-mean log(standard deviations).</p>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Modelling the linear relationship between elevation, latitude and June mean temperature</span>

<span class="c1"># Defining predictors and scaling</span>
<span class="n">predictors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;elevation&#39;</span><span class="p">,</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span>
<span class="n">scaled_predictors</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="s1">&#39;_scaled&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">predictors</span><span class="p">]</span>
<span class="n">target</span> <span class="o">=</span> <span class="s1">&#39;june_mean_temperature&#39;</span>

<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">df_aws_filtered_scaled_predictors</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df_aws_filtered</span><span class="p">[</span><span class="n">predictors</span><span class="p">]),</span><span class="n">columns</span><span class="o">=</span><span class="n">scaled_predictors</span><span class="p">)</span>
<span class="n">df_climate_filtered_scaled_predictors</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">df_climate_filtered</span><span class="p">[</span><span class="n">predictors</span><span class="p">]),</span><span class="n">columns</span><span class="o">=</span><span class="n">scaled_predictors</span><span class="p">)</span>

<span class="c1"># Linear Regression AWS</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Linear Regression AWS:&quot;</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_aws_filtered_scaled_predictors</span><span class="p">,</span><span class="n">df_aws_filtered</span><span class="p">[</span><span class="n">target</span><span class="p">])</span>
<span class="n">df_aws_filtered</span><span class="p">[</span><span class="s1">&#39;june_mean_temperature_predicted_lr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df_aws_filtered_scaled_predictors</span><span class="p">)</span>
<span class="n">feature_importance</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">coef_</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">scaled_predictors</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;intercept:&#39;</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">intercept_</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">feature_importance</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">key</span><span class="o">=</span><span class="nb">abs</span><span class="p">))</span>

<span class="c1"># Linear Regression Climate Model</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Linear Regression Climate Model:&quot;</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_climate_filtered_scaled_predictors</span><span class="p">,</span><span class="n">df_climate_filtered</span><span class="p">[</span><span class="n">target</span><span class="p">])</span>
<span class="n">df_climate_filtered</span><span class="p">[</span><span class="s1">&#39;june_mean_temperature_predicted_lr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df_climate_filtered_scaled_predictors</span><span class="p">)</span>
<span class="n">feature_importance</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">coef_</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">scaled_predictors</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;intercept:&#39;</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">intercept_</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">feature_importance</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">key</span><span class="o">=</span><span class="nb">abs</span><span class="p">))</span>

<span class="n">ds_climate_stacked_landonly_filtered</span><span class="p">[</span><span class="s1">&#39;june_mean_temperature_predicted_lr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">),</span>
    <span class="n">df_climate_filtered</span><span class="p">[</span><span class="s1">&#39;june_mean_temperature_predicted_lr&#39;</span><span class="p">])</span>

<span class="n">ds_aws_filtered</span><span class="p">[</span><span class="s1">&#39;june_mean_temperature_predicted_lr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="s1">&#39;station&#39;</span><span class="p">),</span>
    <span class="n">df_aws_filtered</span><span class="p">[</span><span class="s1">&#39;june_mean_temperature_predicted_lr&#39;</span><span class="p">])</span>

<span class="n">ds_climate_stacked_landonly_filtered</span><span class="p">[</span><span class="s1">&#39;june_mean_temperature_residual_lr&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">ds_climate_stacked_landonly_filtered</span><span class="p">[</span><span class="s1">&#39;june_mean_temperature&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">ds_climate_stacked_landonly_filtered</span><span class="p">[</span><span class="s1">&#39;june_mean_temperature_predicted_lr&#39;</span><span class="p">]</span>
<span class="n">ds_aws_filtered</span><span class="p">[</span><span class="s1">&#39;june_mean_temperature_residual_lr&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">ds_aws_filtered</span><span class="p">[</span><span class="s1">&#39;june_mean_temperature&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">ds_aws_filtered</span><span class="p">[</span><span class="s1">&#39;june_mean_temperature_predicted_lr&#39;</span><span class="p">]</span>

<span class="n">ds_climate_stacked</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">ds_climate_stacked</span><span class="p">,</span><span class="n">ds_climate_stacked_landonly_filtered</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Linear Regression AWS:
intercept: -33.625017170326736
elevation_scaled   -10.160912
latitude_scaled      1.952785
dtype: float64

 Linear Regression Climate Model:
intercept: -33.094520306833495
elevation_scaled   -10.223010
latitude_scaled      2.895803
dtype: float64
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Computing the zero-mean log(standard deviation)</span>
<span class="n">ds_aws_filtered</span><span class="p">[</span><span class="s1">&#39;june_logstd_temperature&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ds_aws_filtered</span><span class="p">[</span><span class="s1">&#39;june_std_temperature&#39;</span><span class="p">])</span>
<span class="n">ds_climate_stacked</span><span class="p">[</span><span class="s1">&#39;june_logstd_temperature&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ds_climate_stacked</span><span class="p">[</span><span class="s1">&#39;june_std_temperature&#39;</span><span class="p">])</span>
<span class="n">ds_climate_nearest_stacked_filtered</span><span class="p">[</span><span class="s1">&#39;june_logstd_temperature&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ds_climate_nearest_stacked_filtered</span><span class="p">[</span><span class="s1">&#39;june_std_temperature&#39;</span><span class="p">])</span>
<span class="n">ds_aws_filtered</span><span class="p">[</span><span class="s1">&#39;june_logstd_temperature_residual_constant&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds_aws_filtered</span><span class="p">[</span><span class="s1">&#39;june_logstd_temperature&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">ds_aws_filtered</span><span class="p">[</span><span class="s1">&#39;june_logstd_temperature&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">ds_climate_stacked</span><span class="p">[</span><span class="s1">&#39;june_logstd_temperature_residual_constant&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds_climate_stacked</span><span class="p">[</span><span class="s1">&#39;june_logstd_temperature&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">ds_climate_stacked</span><span class="p">[</span><span class="s1">&#39;june_logstd_temperature&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">ds_climate_nearest_stacked_filtered</span><span class="p">[</span><span class="s1">&#39;june_logstd_temperature_residual_constant&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">ds_climate_nearest_stacked_filtered</span><span class="p">[</span><span class="s1">&#39;june_logstd_temperature&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">ds_climate_nearest_stacked_filtered</span><span class="p">[</span><span class="s1">&#39;june_logstd_temperature&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plotting the linear regression prediction and residual</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span><span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span><span class="c1">#,frameon=False)</span>

<span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;june_mean_temperature_predicted_lr&#39;</span><span class="p">,</span><span class="s1">&#39;june_mean_temperature_residual_lr&#39;</span><span class="p">,</span><span class="s1">&#39;june_logstd_temperature&#39;</span><span class="p">,</span><span class="s1">&#39;june_logstd_temperature_residual_constant&#39;</span><span class="p">]</span>
<span class="n">cmaps</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span><span class="s1">&#39;RdBu&#39;</span><span class="p">,</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span><span class="s1">&#39;RdBu&#39;</span><span class="p">]</span>
<span class="n">vminmaxs</span> <span class="o">=</span> <span class="p">[(</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span><span class="o">-</span><span class="mi">15</span><span class="p">),(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),(</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">1.6</span><span class="p">),(</span><span class="o">-</span><span class="mf">0.6</span><span class="p">,</span><span class="mf">0.6</span><span class="p">)]</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;June Mean Temperature Predicted (Linear Regression)&#39;</span><span class="p">,</span><span class="s1">&#39;June Mean Temperature Residual (Linear Regression)&#39;</span><span class="p">,</span>
          <span class="s1">&#39;June Log(Standard Deviation)&#39;</span><span class="p">,</span><span class="s1">&#39;June Zero-Mean Log(Standard Deviation)&#39;</span><span class="p">]</span>

<span class="k">for</span> <span class="n">ax</span><span class="p">,</span><span class="n">metric</span><span class="p">,</span><span class="n">vminmax</span><span class="p">,</span><span class="n">cmap</span><span class="p">,</span><span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axs</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">metrics</span><span class="p">,</span><span class="n">vminmaxs</span><span class="p">,</span><span class="n">cmaps</span><span class="p">,</span><span class="n">labels</span><span class="p">):</span>
    <span class="n">background_map_rotatedcoords</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">ds_climate_stacked</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="s1">&#39;glon&#39;</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="s1">&#39;glat&#39;</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
        <span class="n">vmin</span><span class="o">=</span><span class="n">vminmax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">vmax</span><span class="o">=</span><span class="n">vminmax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
        <span class="n">cbar_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fraction&#39;</span><span class="p">:</span><span class="mf">0.030</span><span class="p">,</span>
                    <span class="s1">&#39;pad&#39;</span><span class="p">:</span><span class="mf">0.02</span><span class="p">,</span>
                    <span class="s1">&#39;label&#39;</span><span class="p">:</span><span class="n">label</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="n">ds_aws_filtered</span><span class="p">[</span><span class="s1">&#39;glon&#39;</span><span class="p">],</span>
        <span class="n">ds_aws_filtered</span><span class="p">[</span><span class="s1">&#39;glat&#39;</span><span class="p">],</span>
        <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
        <span class="n">c</span><span class="o">=</span><span class="n">ds_aws_filtered</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span>
        <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
        <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">vmin</span><span class="o">=</span><span class="n">vminmax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">vmax</span><span class="o">=</span><span class="n">vminmax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                       
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/95afa3bd65aeb4fdc24c3fb5a3337dc0fc7e635d552052c4ad475578e4eb36d2.png" src="../../../_images/95afa3bd65aeb4fdc24c3fb5a3337dc0fc7e635d552052c4ad475578e4eb36d2.png" />
</div>
</div>
<p>It’s clear once we remove the linear dependency of temperature with elevation and latitude we get quite a different spatial structure for the mean temperature. This is the spatial structure we’ll want to model using Gaussian processes, where the covariance between nearby sites is captured by parameterising the covariance as a function of distance. In our model we’ll assume a single length scale for the covariance, that is to say we assume the covariance between nearby sites decays at the same distance wherever you are located over Antarctica. While this assumption is clearly broken in certain areas (e.g. covariance in steep regions near to the coast behaves differently to flat regions inland), it still provides a start and is a lot simpler than the approach of considering non-stationary lengthscales across the region (although this is possible). It’s important to consider how this will impact our results and we expect one of the main influences is that the noise term estimated for our Gaussian process will be relatively high to account for the sharp variations between nearby sites in particularly steep regions.</p>
<p>It’s also important to note that the spatial patterns in both the AWS data and climate model data are similar for each metric. That is the climate model is doing a reasonable job at capturing the more complex dependencies of mean temperature and log(standard dev) in temperature. To utilise this, in our model we consider a shared latent Gaussian process between the datasets and so predictions of the unbiased values are made conditioning on both datasets.</p>
</section>
<section id="examining-spatial-covariance-in-the-bias">
<h3><a class="toc-backref" href="#id8" role="doc-backlink">Examining spatial covariance in the bias</a><a class="headerlink" href="#examining-spatial-covariance-in-the-bias" title="Link to this heading">#</a></h3>
<p>It’s also useful to explore the spatial structure of the bias (both in the mean and log(standard deviation) of june temperature). In this exploratory analysis we do this by examining the empirical values of the metrics from the AWS data and the nearest climate model grid-cells.</p>
<p>For the mean temperature, this is done after accounting for the linear relationship with elevation and latitude (that is we examine the spatial structure in the bias of the residuals). For the log(standard deviation), we examine bias in the zero-meaned values for each dataset.</p>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Recomputing nearest neighbours</span>
<span class="n">ds_climate_nearest_stacked</span> <span class="o">=</span> <span class="n">ds_climate_stacked_landonly_filtered</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">nn_indecies</span><span class="p">)</span>
<span class="n">ds_climate_nearest_stacked</span> <span class="o">=</span> <span class="n">ds_climate_nearest_stacked</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">nearest_station</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">ds_aws</span><span class="o">.</span><span class="n">station</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
<span class="n">ds_climate_nearest_stacked</span> <span class="o">=</span> <span class="n">ds_climate_nearest_stacked</span><span class="o">.</span><span class="n">swap_dims</span><span class="p">({</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="s2">&quot;nearest_station&quot;</span><span class="p">})</span>
<span class="n">ds_climate_nearest_stacked_filtered</span> <span class="o">=</span> <span class="n">ds_climate_nearest_stacked</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">nearest_station</span><span class="o">=</span><span class="n">stations_recordsfilter</span><span class="p">)</span>

<span class="c1"># Recomputing the zero-mean log(standard deviation)</span>
<span class="n">ds_climate_nearest_stacked_filtered</span><span class="p">[</span><span class="s1">&#39;june_logstd_temperature&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ds_climate_nearest_stacked_filtered</span><span class="p">[</span><span class="s1">&#39;june_std_temperature&#39;</span><span class="p">])</span>
<span class="n">ds_climate_nearest_stacked_filtered</span><span class="p">[</span><span class="s1">&#39;june_logstd_temperature_residual_constant&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">ds_climate_nearest_stacked_filtered</span><span class="p">[</span><span class="s1">&#39;june_logstd_temperature&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">ds_climate_nearest_stacked_filtered</span><span class="p">[</span><span class="s1">&#39;june_logstd_temperature&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="c1"># Evaluating bias in residuals from linear regression for the mean temperature</span>
<span class="n">ds_climate_nearest_stacked_filtered</span><span class="p">[</span><span class="s1">&#39;bias_june_mean_temperature_residual_lr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="s1">&#39;nearest_station&#39;</span><span class="p">),</span>
    <span class="n">ds_climate_nearest_stacked_filtered</span><span class="p">[</span><span class="s1">&#39;june_mean_temperature_residual_lr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">-</span> <span class="n">ds_aws_filtered</span><span class="p">[</span><span class="s1">&#39;june_mean_temperature_residual_lr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

<span class="c1"># Evaluating bias for the log(std) temperature</span>
<span class="n">ds_climate_nearest_stacked_filtered</span><span class="p">[</span><span class="s1">&#39;bias_june_logstd_temperature_residual_constant&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="s1">&#39;nearest_station&#39;</span><span class="p">),</span>
    <span class="n">ds_climate_nearest_stacked_filtered</span><span class="p">[</span><span class="s1">&#39;june_logstd_temperature_residual_constant&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">-</span> <span class="n">ds_aws_filtered</span><span class="p">[</span><span class="s1">&#39;june_logstd_temperature_residual_constant&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plotting the linear regression residual and bias in the residual for the mean temperature</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span><span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span><span class="c1">#,frameon=False)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">:</span>
    <span class="n">background_map_rotatedcoords</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">plot1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">ds_climate_nearest_stacked_filtered</span><span class="p">[</span><span class="s1">&#39;glon&#39;</span><span class="p">],</span>
    <span class="n">ds_climate_nearest_stacked_filtered</span><span class="p">[</span><span class="s1">&#39;glat&#39;</span><span class="p">],</span>
    <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
    <span class="n">c</span><span class="o">=</span><span class="n">ds_climate_nearest_stacked_filtered</span><span class="p">[</span><span class="s1">&#39;bias_june_mean_temperature_residual_lr&#39;</span><span class="p">],</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu&#39;</span><span class="p">,</span>
    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">vmin</span><span class="o">=-</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">vmax</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">plot1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Bias in June Mean Temperature Residual </span><span class="se">\n</span><span class="s1"> (Linear Regression)&#39;</span><span class="p">)</span><span class="c1">#, orientation=&#39;horizontal&#39;, label=metric)</span>

<span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">plot2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">ds_climate_nearest_stacked_filtered</span><span class="p">[</span><span class="s1">&#39;glon&#39;</span><span class="p">],</span>
    <span class="n">ds_climate_nearest_stacked_filtered</span><span class="p">[</span><span class="s1">&#39;glat&#39;</span><span class="p">],</span>
    <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
    <span class="n">c</span><span class="o">=</span><span class="n">ds_climate_nearest_stacked_filtered</span><span class="p">[</span><span class="s1">&#39;bias_june_logstd_temperature_residual_constant&#39;</span><span class="p">],</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu&#39;</span><span class="p">,</span>
    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">vmin</span><span class="o">=-</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">vmax</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">plot2</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Bias in June Log(Std) Temperature Residual </span><span class="se">\n</span><span class="s1"> (Constant)&#39;</span><span class="p">)</span><span class="c1">#, orientation=&#39;horizontal&#39;, label=metric)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../../../_images/f8789476f87f03854c9cd303783e4f08db7611fe54ddac0a621ce9f8c0bef9fb.png" src="../../../_images/f8789476f87f03854c9cd303783e4f08db7611fe54ddac0a621ce9f8c0bef9fb.png" />
</div>
</div>
<p>There’s clearly a spatial covariance pattern in the bias for both the mean and log(standard dev.). The length scale at which the covariance decays for the bias appears longer than for the raw value of the metrics of each dataset.</p>
</section>
<section id="examining-relationships-between-variables-and-the-bias-in-parameters">
<h3><a class="toc-backref" href="#id9" role="doc-backlink">Examining relationships between variables and the bias in parameters</a><a class="headerlink" href="#examining-relationships-between-variables-and-the-bias-in-parameters" title="Link to this heading">#</a></h3>
<p>It’s interesting to check whether there’s any obvious relationships between the biased parameter values and predictors such as elevation and latitude. Additionally, it’s worth checking if there’s a relationship between the biased and unbiased parameter values. We do this through a partial pairplot as shown below.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Transforming data for plotting with seaborn PairGrid </span>
<span class="nb">vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;elevation&#39;</span><span class="p">,</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span><span class="s1">&#39;june_mean_temperature&#39;</span><span class="p">,</span><span class="s1">&#39;june_std_temperature&#39;</span><span class="p">,</span><span class="s1">&#39;bias_june_mean_temperature_residual_lr&#39;</span><span class="p">,</span><span class="s1">&#39;bias_june_logstd_temperature_residual_constant&#39;</span><span class="p">]</span>
<span class="n">x_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bias_june_mean_temperature_residual_lr&#39;</span><span class="p">,</span><span class="s1">&#39;bias_june_logstd_temperature_residual_constant&#39;</span><span class="p">,</span><span class="s1">&#39;elevation&#39;</span><span class="p">,</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span><span class="s1">&#39;june_mean_temperature&#39;</span><span class="p">,</span><span class="s1">&#39;june_std_temperature&#39;</span><span class="p">]</span>
<span class="n">y_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bias_june_mean_temperature_residual_lr&#39;</span><span class="p">,</span><span class="s1">&#39;bias_june_logstd_temperature_residual_constant&#39;</span><span class="p">]</span>
<span class="n">df_bias_climate</span> <span class="o">=</span> <span class="n">ds_climate_nearest_stacked_filtered</span><span class="p">[</span><span class="nb">vars</span><span class="p">]</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()[</span><span class="nb">vars</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Plotting PairGrid with regression lines</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">PairGrid</span><span class="p">(</span><span class="n">df_bias_climate</span><span class="p">,</span> <span class="n">x_vars</span><span class="o">=</span><span class="n">x_vars</span><span class="p">,</span><span class="n">y_vars</span><span class="o">=</span><span class="n">y_vars</span><span class="p">,</span><span class="n">height</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">diag_sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="c1">#, corner=True)</span>

<span class="n">reg_kws</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;scatter&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;line_kws&#39;</span><span class="p">:{</span><span class="s1">&#39;linewidth&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}}</span>
<span class="n">g</span><span class="o">.</span><span class="n">map_offdiag</span><span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">,</span><span class="o">**</span><span class="n">reg_kws</span><span class="p">)</span>

<span class="n">g</span><span class="o">.</span><span class="n">hue_kws</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;marker&#39;</span><span class="p">:[</span><span class="s1">&#39;+&#39;</span><span class="p">],</span><span class="s1">&#39;s&#39;</span><span class="p">:[</span><span class="mi">5</span><span class="p">],</span><span class="s1">&#39;alpha&#39;</span><span class="p">:[</span><span class="mf">1.0</span><span class="p">]}</span>
<span class="n">scatter_kws</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;linewidth&#39;</span><span class="p">:</span><span class="mf">0.8</span><span class="p">}</span>
<span class="n">g</span><span class="o">.</span><span class="n">map_offdiag</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">,</span><span class="o">**</span><span class="n">scatter_kws</span><span class="p">)</span>

<span class="n">hist_kws</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;common_norm&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span><span class="s1">&#39;stat&#39;</span><span class="p">:</span><span class="s1">&#39;density&#39;</span><span class="p">}</span>
<span class="n">g</span><span class="o">.</span><span class="n">map_diag</span><span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">,</span><span class="o">**</span><span class="n">hist_kws</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;seaborn.axisgrid.PairGrid at 0x7f6fd049a080&gt;
</pre></div>
</div>
<img alt="../../../_images/10740e788419b8cbddf9af54318f5efc84642a2c01759f5604ce6f2e832ed513.png" src="../../../_images/10740e788419b8cbddf9af54318f5efc84642a2c01759f5604ce6f2e832ed513.png" />
</div>
</div>
<p>The above pairplot only shows weak relationships between the bias in parameters and the other variables. Therefore, in the model we’ll assume the bias is generated from an independent underlying process.</p>
</section>
</section>
<section id="data-preprocessing">
<h2><a class="toc-backref" href="#id10" role="doc-backlink">Data Preprocessing</a><a class="headerlink" href="#data-preprocessing" title="Link to this heading">#</a></h2>
<p>The main pre-processing steps we’ll do are simply scaling the elevation and latitude predictors and removing any AWS sites with only 2 records for average June temperature. We also define a random subsample of the climate model grid-cells, which we’ll use for inference on the parameters of the Gaussian processes in order to reduce the computational demands. Additionally, all the data is transformed away from Xarray and into a dictionary of device arrays (JAX versions of Numpy arrays) of the right shape that the inference package Numpyro expects.</p>
<div class="note dropdown admonition">
<p class="admonition-title">Computational Complexity and Subsampling:</p>
<p>While Gaussian processes are extremely useful and flexible, their high computational demand of is often described as their Achilles’ heel. Typically, the time for inference scales as the cube of the number of data points, which is a result of taking the inverse of the covariance matrix when computing the likelihood of a set of data for given hyper-parameters. However, there are various methods for improving the speed of inference, such as sparse variational Gaussian processes (SVGPs). These are not utilised in this notebook as they require some additional complexity. Instead we do the sub-optimal procedure of simply only using a subsample of the climate model data for inference. This approach is clearly sub-optimal as it doesn’t target the regions of most interest, however, hopefully it’ll still produce sensible results and be sufficient for this tutorial example.</p>
</div>
<div class="note dropdown admonition">
<p class="admonition-title">Additional Preprocessing:</p>
<p>Note that some pre-filtering has already been conducted to the data made available for the notebook, such as removing weather stations located on islands and filtering the climate model output to land onlu etc. These steps can be found in the <a class="reference external" href="http://preprocessing.py">preprocessing.py</a> file of the notebook repository. Additionally, while not done in this notebook, it’s important to mention that typically feature engineering is an important component of preprocessing and we could for example derive a distance to the coast predictor.</p>
</div>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Filtering to June records and stations with more than 2 records</span>
<span class="n">aws_june_filter</span> <span class="o">=</span> <span class="n">ds_aws</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ds_aws</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">6</span><span class="p">,</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">ds_aws_preprocessed</span> <span class="o">=</span> <span class="n">ds_aws</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">aws_june_filter</span><span class="p">)</span>
<span class="n">aws_stations_recordsfilter</span> <span class="o">=</span> <span class="n">ds_aws_preprocessed</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ds_aws_preprocessed</span><span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">([</span><span class="s1">&#39;t&#39;</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">,</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s1">&#39;station&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">ds_aws_preprocessed</span> <span class="o">=</span> <span class="n">ds_aws_preprocessed</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">station</span><span class="o">=</span><span class="n">aws_stations_recordsfilter</span><span class="p">)</span>

<span class="n">climate_june_filter</span> <span class="o">=</span> <span class="n">ds_climate</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ds_climate</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">6</span><span class="p">,</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">ds_climate_preprocessed</span> <span class="o">=</span> <span class="n">ds_climate</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">climate_june_filter</span><span class="p">)</span>
<span class="n">ds_climate_preprocessed</span> <span class="o">=</span> <span class="n">ds_climate_preprocessed</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;grid_longitude&#39;</span><span class="p">,</span> <span class="s1">&#39;grid_latitude&#39;</span><span class="p">))</span>
<span class="n">ds_climate_preprocessed</span> <span class="o">=</span> <span class="n">ds_climate_preprocessed</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="n">random_sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ds_climate_preprocessed</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])),</span> <span class="n">size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">ds_climate_preprocessed_sample</span> <span class="o">=</span> <span class="n">ds_climate_preprocessed</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">random_sample</span><span class="p">)</span>

<span class="c1"># Scaling latitude and elevation </span>
<span class="n">lat_scalar</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">ele_scalar</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">ds_aws_preprocessed</span><span class="p">[</span><span class="s1">&#39;latitude_scaled&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;station&#39;</span><span class="p">],</span>  <span class="n">lat_scalar</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">ds_aws_preprocessed</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))[:,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ds_aws_preprocessed</span><span class="p">[</span><span class="s1">&#39;elevation_scaled&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;station&#39;</span><span class="p">],</span> <span class="n">ele_scalar</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">ds_aws_preprocessed</span><span class="p">[</span><span class="s1">&#39;elevation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))[:,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ds_climate_preprocessed</span><span class="p">[</span><span class="s1">&#39;latitude_scaled&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">lat_scalar</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">ds_climate_preprocessed</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))[:,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ds_climate_preprocessed</span><span class="p">[</span><span class="s1">&#39;elevation_scaled&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">ele_scalar</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">ds_climate_preprocessed</span><span class="p">[</span><span class="s1">&#39;elevation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))[:,</span><span class="mi">0</span><span class="p">])</span>

<span class="c1"># Transforming into dictionary of device arrays</span>
<span class="n">ox</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">([</span><span class="n">ds_aws_preprocessed</span><span class="p">[</span><span class="s1">&#39;glon&#39;</span><span class="p">],</span><span class="n">ds_aws_preprocessed</span><span class="p">[</span><span class="s1">&#39;glat&#39;</span><span class="p">]]))[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">odata</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ds_aws_preprocessed</span><span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
<span class="n">olat</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ds_aws_preprocessed</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">oele</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ds_aws_preprocessed</span><span class="p">[</span><span class="s1">&#39;elevation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">olat_scaled</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ds_aws_preprocessed</span><span class="p">[</span><span class="s1">&#39;latitude_scaled&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">oele_scaled</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ds_aws_preprocessed</span><span class="p">[</span><span class="s1">&#39;elevation_scaled&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

<span class="n">cx</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">([</span><span class="n">ds_climate_preprocessed</span><span class="p">[</span><span class="s1">&#39;glon&#39;</span><span class="p">],</span><span class="n">ds_climate_preprocessed</span><span class="p">[</span><span class="s1">&#39;glat&#39;</span><span class="p">]]))[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">cdata</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ds_climate_preprocessed</span><span class="o">.</span><span class="n">transpose</span><span class="p">()[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
<span class="n">clat</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ds_climate_preprocessed</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">cele</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ds_climate_preprocessed</span><span class="p">[</span><span class="s1">&#39;elevation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">clat_scaled</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ds_climate_preprocessed</span><span class="p">[</span><span class="s1">&#39;latitude_scaled&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">cele_scaled</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ds_climate_preprocessed</span><span class="p">[</span><span class="s1">&#39;elevation_scaled&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

<span class="n">cx_subsample</span> <span class="o">=</span> <span class="n">cx</span><span class="p">[</span><span class="n">random_sample</span><span class="p">]</span>
<span class="n">cdata_subsample</span> <span class="o">=</span> <span class="n">cdata</span><span class="p">[:,</span><span class="n">random_sample</span><span class="p">]</span>
<span class="n">cele_subsample</span> <span class="o">=</span> <span class="n">cele</span><span class="p">[</span><span class="n">random_sample</span><span class="p">]</span>
<span class="n">clat_subsample</span> <span class="o">=</span> <span class="n">clat</span><span class="p">[</span><span class="n">random_sample</span><span class="p">]</span>
<span class="n">cele_scaled_subsample</span> <span class="o">=</span> <span class="n">cele_scaled</span><span class="p">[</span><span class="n">random_sample</span><span class="p">]</span>
<span class="n">clat_scaled_subsample</span> <span class="o">=</span> <span class="n">clat_scaled</span><span class="p">[</span><span class="n">random_sample</span><span class="p">]</span>

<span class="n">data_dictionary</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;ds_aws_preprocessed&#39;</span><span class="p">:</span><span class="n">ds_aws_preprocessed</span><span class="p">,</span>
    <span class="s1">&#39;ds_climate_preprocessed&#39;</span><span class="p">:</span><span class="n">ds_climate_preprocessed</span><span class="p">,</span>
    <span class="s1">&#39;ds_climate_preprocessed_sample&#39;</span><span class="p">:</span><span class="n">ds_climate_preprocessed_sample</span><span class="p">,</span>
    <span class="s1">&#39;ox&#39;</span><span class="p">:</span><span class="n">ox</span><span class="p">,</span>
    <span class="s1">&#39;odata&#39;</span><span class="p">:</span><span class="n">odata</span><span class="p">,</span>
    <span class="s1">&#39;olat&#39;</span><span class="p">:</span><span class="n">olat</span><span class="p">,</span>
    <span class="s1">&#39;oele&#39;</span><span class="p">:</span><span class="n">oele</span><span class="p">,</span>
    <span class="s1">&#39;olat_scaled&#39;</span><span class="p">:</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">olat_scaled</span><span class="p">),</span>
    <span class="s1">&#39;oele_scaled&#39;</span><span class="p">:</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">oele_scaled</span><span class="p">),</span>
    <span class="s1">&#39;cx&#39;</span><span class="p">:</span><span class="n">cx</span><span class="p">,</span>
    <span class="s1">&#39;cdata&#39;</span><span class="p">:</span><span class="n">cdata</span><span class="p">,</span>
    <span class="s1">&#39;clat&#39;</span><span class="p">:</span><span class="n">clat</span><span class="p">,</span>
    <span class="s1">&#39;cele&#39;</span><span class="p">:</span><span class="n">cele</span><span class="p">,</span>
    <span class="s1">&#39;clat_scaled&#39;</span><span class="p">:</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">clat_scaled</span><span class="p">),</span>
    <span class="s1">&#39;cele_scaled&#39;</span><span class="p">:</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cele_scaled</span><span class="p">),</span>
    <span class="s1">&#39;cx_subsample&#39;</span><span class="p">:</span><span class="n">cx_subsample</span><span class="p">,</span>
    <span class="s1">&#39;cdata_subsample&#39;</span><span class="p">:</span><span class="n">cdata_subsample</span><span class="p">,</span>
    <span class="s1">&#39;cele_subsample&#39;</span><span class="p">:</span><span class="n">cele_subsample</span><span class="p">,</span>
    <span class="s1">&#39;clat_subsample&#39;</span><span class="p">:</span><span class="n">clat_subsample</span><span class="p">,</span>
    <span class="s1">&#39;cele_scaled_subsample&#39;</span><span class="p">:</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cele_scaled_subsample</span><span class="p">),</span>
    <span class="s1">&#39;clat_scaled_subsample&#39;</span><span class="p">:</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">clat_scaled_subsample</span><span class="p">),</span>
    <span class="s1">&#39;ele_scaler&#39;</span><span class="p">:</span><span class="n">ele_scalar</span><span class="p">,</span>
    <span class="s1">&#39;lat_scaler&#39;</span><span class="p">:</span><span class="n">lat_scalar</span><span class="p">,</span>
    <span class="s1">&#39;random_sample&#39;</span><span class="p">:</span><span class="n">random_sample</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># with open(&#39;/home/jez/Bias_Correction_Application/walkthrough_tutorial/data_dictionary_new.pkl&#39;, &#39;wb&#39;) as f:</span>
<span class="c1">#     pickle.dump(data_dictionary, f)</span>
</pre></div>
</div>
</div>
</div>
<p>It’s worth plotting the locations of the sampled climate model grid-cells and it’s also worth performing a quick sanity check that the data is in the right format:</p>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Sanity Check</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Shapes:&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data_dictionary</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ds_aws_preprocessed&#39;</span><span class="p">,</span><span class="s1">&#39;ds_climate_preprocessed&#39;</span><span class="p">,</span><span class="s1">&#39;ds_climate_preprocessed_sample&#39;</span><span class="p">,</span><span class="s1">&#39;ele_scaler&#39;</span><span class="p">,</span><span class="s1">&#39;lat_scaler&#39;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1"> shape: </span><span class="si">{</span><span class="n">data_dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Values:&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data_dictionary</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ds_aws_preprocessed&#39;</span><span class="p">,</span><span class="s1">&#39;ds_climate_preprocessed&#39;</span><span class="p">,</span><span class="s1">&#39;ds_climate_preprocessed_sample&#39;</span><span class="p">,</span><span class="s1">&#39;ele_scaler&#39;</span><span class="p">,</span><span class="s1">&#39;lat_scaler&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">==</span><span class="s1">&#39;odata&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1"> min=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">data_dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">data_dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, max=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">data_dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1"> min=</span><span class="si">{</span><span class="n">data_dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, mean=</span><span class="si">{</span><span class="n">data_dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, max=</span><span class="si">{</span><span class="n">data_dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Types:&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data_dictionary</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1"> type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">data_dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Shapes:
ox shape: (156, 2)
odata shape: (42, 156)
olat shape: (156,)
oele shape: (156,)
olat_scaled shape: (156,)
oele_scaled shape: (156,)
cx shape: (5724, 2)
cdata shape: (38, 5724)
clat shape: (5724,)
cele shape: (5724,)
clat_scaled shape: (5724,)
cele_scaled shape: (5724,)
cx_subsample shape: (100, 2)
cdata_subsample shape: (38, 100)
cele_subsample shape: (100,)
clat_subsample shape: (100,)
cele_scaled_subsample shape: (100,)
clat_scaled_subsample shape: (100,)
random_sample shape: (100,)

 Values:
ox min=-24.0, mean=-1.7, max=21.5
odata min=-70.3, mean=-33.4, max=-7.9
olat min=-90.0, mean=-76.4, max=-65.2
oele min=5.0, mean=1246.4, max=4093.0
olat_scaled min=-2.6, mean=-0.0, max=2.1
oele_scaled min=-1.1, mean=0.0, max=2.5
cx min=-24.9, mean=2.5, max=24.4
cdata min=-73.3, mean=-39.6, max=-7.0
clat min=-89.7, mean=-76.6, max=-64.0
cele min=-3.1, mean=2003.6, max=4063.5
clat_scaled min=-2.5, mean=-0.0, max=2.4
cele_scaled min=-1.1, mean=0.7, max=2.5
cx_subsample min=-18.8, mean=3.2, max=21.7
cdata_subsample min=-68.7, mean=-39.3, max=-8.6
cele_subsample min=34.2, mean=1956.3, max=3723.6
clat_subsample min=-87.8, mean=-76.1, max=-67.3
cele_scaled_subsample min=-1.1, mean=0.6, max=2.2
clat_scaled_subsample min=-2.2, mean=0.0, max=1.7
random_sample min=71.0, mean=3062.9, max=5616.0

 Types:
ds_aws_preprocessed type: &lt;class &#39;xarray.core.dataset.Dataset&#39;&gt;
ds_climate_preprocessed type: &lt;class &#39;xarray.core.dataset.Dataset&#39;&gt;
ds_climate_preprocessed_sample type: &lt;class &#39;xarray.core.dataset.Dataset&#39;&gt;
ox type: &lt;class &#39;jaxlib.xla_extension.ArrayImpl&#39;&gt;
odata type: &lt;class &#39;jaxlib.xla_extension.ArrayImpl&#39;&gt;
olat type: &lt;class &#39;jaxlib.xla_extension.ArrayImpl&#39;&gt;
oele type: &lt;class &#39;jaxlib.xla_extension.ArrayImpl&#39;&gt;
olat_scaled type: &lt;class &#39;jaxlib.xla_extension.ArrayImpl&#39;&gt;
oele_scaled type: &lt;class &#39;jaxlib.xla_extension.ArrayImpl&#39;&gt;
cx type: &lt;class &#39;jaxlib.xla_extension.ArrayImpl&#39;&gt;
cdata type: &lt;class &#39;jaxlib.xla_extension.ArrayImpl&#39;&gt;
clat type: &lt;class &#39;jaxlib.xla_extension.ArrayImpl&#39;&gt;
cele type: &lt;class &#39;jaxlib.xla_extension.ArrayImpl&#39;&gt;
clat_scaled type: &lt;class &#39;jaxlib.xla_extension.ArrayImpl&#39;&gt;
cele_scaled type: &lt;class &#39;jaxlib.xla_extension.ArrayImpl&#39;&gt;
cx_subsample type: &lt;class &#39;jaxlib.xla_extension.ArrayImpl&#39;&gt;
cdata_subsample type: &lt;class &#39;jaxlib.xla_extension.ArrayImpl&#39;&gt;
cele_subsample type: &lt;class &#39;jaxlib.xla_extension.ArrayImpl&#39;&gt;
clat_subsample type: &lt;class &#39;jaxlib.xla_extension.ArrayImpl&#39;&gt;
cele_scaled_subsample type: &lt;class &#39;jaxlib.xla_extension.ArrayImpl&#39;&gt;
clat_scaled_subsample type: &lt;class &#39;jaxlib.xla_extension.ArrayImpl&#39;&gt;
ele_scaler type: &lt;class &#39;sklearn.preprocessing._data.StandardScaler&#39;&gt;
lat_scaler type: &lt;class &#39;sklearn.preprocessing._data.StandardScaler&#39;&gt;
random_sample type: &lt;class &#39;numpy.ndarray&#39;&gt;
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plotting the subsample locations</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span><span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span><span class="c1">#,frameon=False)</span>
<span class="n">background_map_rotatedcoords</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">ds_climate_preprocessed_sample</span><span class="p">[</span><span class="s1">&#39;glon&#39;</span><span class="p">],</span>
    <span class="n">ds_climate_preprocessed_sample</span><span class="p">[</span><span class="s1">&#39;glat&#39;</span><span class="p">],</span>
    <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span>
    <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
    <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/95ffd176fa17c85012ac5bdc84170d5748c526666cc823ff3640ee8b7f31e9f3.png" src="../../../_images/95ffd176fa17c85012ac5bdc84170d5748c526666cc823ff3640ee8b7f31e9f3.png" />
</div>
</details>
</div>
</section>
<section id="defining-the-model">
<h2><a class="toc-backref" href="#id11" role="doc-backlink">Defining the model</a><a class="headerlink" href="#defining-the-model" title="Link to this heading">#</a></h2>
<p>Let <span class="math notranslate nohighlight">\(Y(s,t)\)</span> represent the random variable for the June temperature from the AWS data at a particular time and location. Let <span class="math notranslate nohighlight">\(Z(s,t)\)</span> represent the equivalent but for the climate model output. We treat the marginal distribution of <span class="math notranslate nohighlight">\(Y(s,t)\)</span> and <span class="math notranslate nohighlight">\(Z(s,t)\)</span> as Normal, such that <span class="math notranslate nohighlight">\(Y(s)\sim \mathcal{N}(\mu_Y(s),\sigma_Y(s))\)</span> and <span class="math notranslate nohighlight">\(Z(s)\sim \mathcal{N}(\mu_Z(s),\sigma_Z(s))\)</span>.</p>
<p>To model the spatial covariance in the parameters we use Gaussian processes. A log transformation is applied to the standard deviation (<span class="math notranslate nohighlight">\(\tilde{\sigma}=log(\sigma)\)</span>) so that it’s on the -<span class="math notranslate nohighlight">\(\infty,\infty\)</span> sample space of a Gaussian process. Shared latent Gaussian processes are considered between the datasets as well as an independent Gaussian process that generates the bias in the climate model output. The parameters for the climate model are then considered as the sum of an unbiased and biased component <span class="math notranslate nohighlight">\(\mu_Z(s)=\mu_Y(s)+\mu_B(s)\)</span> and <span class="math notranslate nohighlight">\(\tilde{\sigma}_Z(s)=\tilde{\sigma}_Y(s)+\tilde{\sigma}_B(s)\)</span>, where each component is modelled as generated from a Gaussian process. The Gaussian processes are parameterised by a mean function and covariance function. The mean function for <span class="math notranslate nohighlight">\(\mu_Y(s)\)</span> is considered linear with respect to elevation and latitude, while for the other parameters it is considered a constant. The covariance function is taken as a Matern3/2 kernel with a lengthscale <span class="math notranslate nohighlight">\(l\)</span> and variance <span class="math notranslate nohighlight">\(v\)</span>.</p>
<div class="math notranslate nohighlight">
\[\mu_Y(S) \sim \mathcal{GP}(m_{\mu_Y}(s)|\beta_{\mu_Y},k(s,s'|l_{\mu_Y},v_{\mu_Y}))\]</div>
<div class="math notranslate nohighlight">
\[\mu_B(S) \sim \mathcal{GP}(m_{\mu_B},k(s,s'|l_{\mu_B},v_{\mu_B}))\]</div>
<div class="math notranslate nohighlight">
\[\tilde{\sigma}_Y(S) \sim \mathcal{GP}(m_{\tilde{\sigma}_Y},k(s,s'|l_{\tilde{\sigma}_Y},v_{\tilde{\sigma}_Y}))\]</div>
<div class="math notranslate nohighlight">
\[\tilde{\sigma}_B(S) \sim \mathcal{GP}(m_{\tilde{\sigma}_B},k(s,s'|l_{\tilde{\sigma}_B},v_{\tilde{\sigma}_B}))\]</div>
<p>The plate diagram below shows the relational dependence between the parameters of the model.</p>
<div class="note dropdown admonition">
<p class="admonition-title">Mean Function and Covariance Function:</p>
<p>The mean function for the parameter <span class="math notranslate nohighlight">\(\mu_Y(s)\)</span> is taken as <span class="math notranslate nohighlight">\(m_{\mu_Y}(s)=\beta_{0,\mu_Y} + \beta_{1,\mu_Y} \cdot x_{ele}(s) + \beta_{2,\mu_Y} \cdot x_{lat}(s)\)</span>.</p>
<p>The covariance function is taken as a Matern3/2 kernel for each parameter, that is: <span class="math notranslate nohighlight">\(k_{M^{3/2}}(s,s')=v\left(1+\dfrac{\sqrt{3}|s-s'|}{l}exp\left({-\dfrac{\sqrt{3}|s-s'|}{l}}\right)\right)\)</span>. The distance <span class="math notranslate nohighlight">\(|s-s'|\)</span> between points is computed from the ‘grid_latitude’ and ‘grid_longitude’ coordinates, which are approximately Euclidean across the domain. The matern3/2 kernel is a popular choice for real-world data applications, see this blog by Andy Jones for some additional info: <a class="reference external" href="https://andrewcharlesjones.github.io/journal/matern-kernels.html">The Matérn class of covariance functions
</a>.</p>
</div>
<p><img alt="alt text" src="../../../_images/model_diagram.png" /></p>
<section id="splitting-up-the-model-for-computation">
<h3><a class="toc-backref" href="#id12" role="doc-backlink">Splitting up the model for computation</a><a class="headerlink" href="#splitting-up-the-model-for-computation" title="Link to this heading">#</a></h3>
<p>It’s quite common when using Gaussian processes to fit the mean function independently of the covariance function. That is to say a mean function is fit to the data initially and then the zero-mean data is fit using the GP implementation that handles covariances between points. There are various reasons for this, such as making the covariance matrix more well-conditioned for inference.</p>
<p>In this notebook we’ll split up the model into a first component estimating the parameters <span class="math notranslate nohighlight">\(\mu_Y(s_Y)\)</span>, <span class="math notranslate nohighlight">\(\mu_Z(s_Z)\)</span>, <span class="math notranslate nohighlight">\(\tilde{\sigma}_Y(s_Y)\)</span> and <span class="math notranslate nohighlight">\(\tilde{\sigma}_Z(s_Z)\)</span> at the AWS and climate model grid cell locations, along with the global parameter values for the mean functions of the latent Gaussian processes <span class="math notranslate nohighlight">\(\beta_{0,\mu_Y}\)</span>, <span class="math notranslate nohighlight">\(\beta_{1,\mu_Y}\)</span>, <span class="math notranslate nohighlight">\(\beta_{2,\mu_Y}\)</span>, <span class="math notranslate nohighlight">\(m_{\mu_B}\)</span>, <span class="math notranslate nohighlight">\(m_{\tilde{\sigma}_Y}\)</span> and <span class="math notranslate nohighlight">\(m_{\tilde{\sigma}_B}\)</span>. Then the second component will use the residuals <span class="math notranslate nohighlight">\(r_{\mu_Y}(s_Y)\)</span>, <span class="math notranslate nohighlight">\(r_{\mu_Z}(s_Z)\)</span>, <span class="math notranslate nohighlight">\(r_{\tilde{\sigma}_Y}(s_Y)\)</span> and <span class="math notranslate nohighlight">\(r_{\tilde{\sigma}_Z}(s_Z)\)</span> to estimate the parameters of the covariance function for the latent Gaussian processes <span class="math notranslate nohighlight">\(l_{\mu_Y}\)</span>, <span class="math notranslate nohighlight">\(v_{\mu_Y}\)</span>, <span class="math notranslate nohighlight">\(l_{\mu_B}\)</span>, <span class="math notranslate nohighlight">\(v_{\mu_B}\)</span>, <span class="math notranslate nohighlight">\(l_{\tilde{\sigma}_Y}\)</span>, <span class="math notranslate nohighlight">\(v_{\tilde{\sigma}_Y}\)</span>, <span class="math notranslate nohighlight">\(l_{\tilde{\sigma}_B}\)</span> and <span class="math notranslate nohighlight">\(v_{\tilde{\sigma}_B}\)</span>.</p>
<div class="note dropdown admonition">
<p class="admonition-title">Modelling assumptions and splitting up the model:</p>
<p>It’s important to consider the impact of splitting up the hierarchical model and what assumptions it makes. The main assumption we make is that the noise in <span class="math notranslate nohighlight">\(\mu_Y(s_Y)\)</span>, <span class="math notranslate nohighlight">\(\mu_Z(s_Z)\)</span>, <span class="math notranslate nohighlight">\(\tilde{\sigma}_Y(s_Y)\)</span> and <span class="math notranslate nohighlight">\(\tilde{\sigma}_Z(s_Z)\)</span> is Gaussian, which seems reasonable. However, if we expected the posterior distributions of these parameters to be highly skewed and non-Gaussian then splitting up the model wouldn’t adequately capture this and keeping a hierarchical model would better represent the uncertainty in the final predictive distributions.</p>
</div>
<div class="note dropdown admonition">
<p class="admonition-title">Model Diagram Component 1: Mean Function:</p>
<p><img alt="alt text" src="../../../_images/model_diagram_part1.png" /></p>
</div>
<div class="note dropdown admonition">
<p class="admonition-title">Model Diagram Component 2: Residuals and Covariance</p>
<p><img alt="alt text" src="../../../_images/model_diagram_part2.png" /></p>
</div>
</section>
</section>
<section id="parameter-inference">
<h2><a class="toc-backref" href="#id13" role="doc-backlink">Parameter Inference</a><a class="headerlink" href="#parameter-inference" title="Link to this heading">#</a></h2>
<p>Inference is performed on the two components of the model separately. To limit the runtime of this notebook, we’ll provide the code for running the inference but will perform the actual inference separately and load in the output to examine. The python scripts for running the inference seperately and saving the output are available via the <a class="reference external" href="https://github.com/Jez-Carter/Bias_Correction_Application/tree/jupyterbook_render">jupterbook_render branch</a> of the repository.</p>
<section id="inference-on-parameters-of-the-mean-function">
<h3><a class="toc-backref" href="#id14" role="doc-backlink">Inference on parameters of the mean function</a><a class="headerlink" href="#inference-on-parameters-of-the-mean-function" title="Link to this heading">#</a></h3>
<p>Utilising the Numpyro python package to define the model for component 1:</p>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The model for predicting the mean and logvar for each dataset as well as the parameters for the meanfunction giving domain-wide behaviour</span>
<span class="k">def</span> <span class="nf">meanfunc_model</span><span class="p">(</span><span class="n">data_dictionary</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function for defining the GP mean function model for the temperature data</span>
<span class="sd">    Args:</span>
<span class="sd">        data_dictionary (python dictionary): dictionary holding the data needed for the model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">omean_b0</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;omean_b0&quot;</span><span class="p">,</span><span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;omean_b0_prior&#39;</span><span class="p">])</span>
    <span class="n">omean_b1</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;omean_b1&quot;</span><span class="p">,</span><span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;omean_b1_prior&#39;</span><span class="p">])</span>
    <span class="n">omean_b2</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;omean_b2&quot;</span><span class="p">,</span><span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;omean_b2_prior&#39;</span><span class="p">])</span>
    <span class="n">omean_noise</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;omean_noise&quot;</span><span class="p">,</span><span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;omean_noise_prior&#39;</span><span class="p">])</span>
    <span class="n">omean_func</span> <span class="o">=</span> <span class="n">omean_b0</span> <span class="o">+</span> <span class="n">omean_b1</span><span class="o">*</span><span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;oele_scaled&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">omean_b2</span><span class="o">*</span><span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;olat_scaled&#39;</span><span class="p">]</span>
    <span class="n">omean</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;omean&quot;</span><span class="p">,</span><span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">omean_func</span><span class="p">,</span> <span class="n">omean_noise</span><span class="p">))</span>

    <span class="n">ologvar_b0</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;ologvar_b0&quot;</span><span class="p">,</span><span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;ologvar_b0_prior&#39;</span><span class="p">])</span>
    <span class="n">ologvar_noise</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;ologvar_noise&quot;</span><span class="p">,</span><span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;ologvar_noise_prior&#39;</span><span class="p">])</span>
    <span class="n">ologvar_func</span> <span class="o">=</span> <span class="n">ologvar_b0</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;ox&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ologvar</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;ologvar&quot;</span><span class="p">,</span><span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">ologvar_func</span><span class="p">,</span> <span class="n">ologvar_noise</span><span class="p">))</span>
    <span class="n">ovar</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">ologvar</span><span class="p">)</span>

    <span class="n">obs_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;odata&#39;</span><span class="p">])</span><span class="o">==</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;AWS Temperature&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">omean</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ovar</span><span class="p">))</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">obs_mask</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">data_dictionary</span><span class="p">[</span><span class="s2">&quot;odata&quot;</span><span class="p">])</span>

    <span class="n">cmean_b0</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;cmean_b0&quot;</span><span class="p">,</span><span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;cmean_b0_prior&#39;</span><span class="p">])</span>
    <span class="n">cmean_noise</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;cmean_noise&quot;</span><span class="p">,</span><span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;cmean_noise_prior&#39;</span><span class="p">])</span>
    <span class="n">cmean_func</span> <span class="o">=</span> <span class="n">cmean_b0</span> <span class="o">+</span> <span class="n">omean_b1</span><span class="o">*</span><span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;cele_scaled&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">omean_b2</span><span class="o">*</span><span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;clat_scaled&#39;</span><span class="p">]</span>
    <span class="n">cmean</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;cmean&quot;</span><span class="p">,</span><span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">cmean_func</span><span class="p">,</span> <span class="n">cmean_noise</span><span class="p">))</span>

    <span class="n">clogvar_b0</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;clogvar_b0&quot;</span><span class="p">,</span><span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;clogvar_b0_prior&#39;</span><span class="p">])</span>
    <span class="n">clogvar_noise</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;clogvar_noise&quot;</span><span class="p">,</span><span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;clogvar_noise_prior&#39;</span><span class="p">])</span>
    <span class="n">clogvar_func</span> <span class="o">=</span> <span class="n">clogvar_b0</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;cx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">clogvar</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;clogvar&quot;</span><span class="p">,</span><span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">clogvar_func</span><span class="p">,</span> <span class="n">clogvar_noise</span><span class="p">))</span>
    <span class="n">cvar</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">clogvar</span><span class="p">)</span>

    <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;Climate Temperature&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">cmean</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cvar</span><span class="p">)),</span> <span class="n">obs</span><span class="o">=</span><span class="n">data_dictionary</span><span class="p">[</span><span class="s2">&quot;cdata&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>In the model definition ‘omean’ represents the mean June temperature estimate at each AWS location, while ‘cmean’ is the the equivalent for the climate model output at the grid-cell locations. Similarly, ‘ologvar’ and ‘clogvar’ represents for the log-variance for each dataset and location respectively. The model follows the following equations:</p>
<div class="math notranslate nohighlight">
\[\mu_Y(s)=m_{\mu_Y}(s)+r_{\mu_Y} \hspace{5em} \mu_Z(s)=m_{\mu_Z}(s)+r_{\mu_Z}\]</div>
<div class="math notranslate nohighlight">
\[\tilde{\sigma}_Y(s)=m_{\tilde{\sigma}_Y}(s)+r_{\tilde{\sigma}_Y} \hspace{5em} \tilde{\sigma}_Z(s)=m_{\tilde{\sigma}_Z}(s)+r_{\tilde{\sigma}_Z}\]</div>
<div class="math notranslate nohighlight">
\[m_{\mu_Y}(s)=\beta_{0,\mu_Y} + \beta_{1,\mu} \cdot x_{ele}(s) + \beta_{2,\mu} \cdot x_{lat}(s)\]</div>
<div class="math notranslate nohighlight">
\[m_{\mu_Z}(s)=\beta_{0,\mu_Z} + \beta_{1,\mu} \cdot x_{ele}(s) + \beta_{2,\mu} \cdot x_{lat}(s)\]</div>
<!-- $$r_{\mu_Y}(s)\sim\mathcal{N}(0,n_{\mu_Y})$$
$$r_{\mu_Y}(s)\sim\mathcal{N}(0,n_{\mu_Y})$$ --><p>Defining a function for running the Bayesian inference on the model parameters given the data:</p>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># A function to run inference on the model</span>
<span class="k">def</span> <span class="nf">run_inference</span><span class="p">(</span>
    <span class="n">model</span><span class="p">,</span> <span class="n">rng_key</span><span class="p">,</span> <span class="n">num_warmup</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">,</span> <span class="n">num_chains</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function for doing MCMC inference</span>
<span class="sd">    Args:</span>
<span class="sd">        model (python function): function that follows numpyros syntax</span>
<span class="sd">        rng_key (np array): PRNGKey for reproducible results</span>
<span class="sd">        num_warmup (int): Number of MCMC steps for warmup</span>
<span class="sd">        num_samples (int): Number of MCMC samples to take of parameters after warmup</span>
<span class="sd">        num_chains (int): Number of chains to run in parallel (or sequentially without GPU)</span>
<span class="sd">        *args: Additional arguments to pass to the model</span>
<span class="sd">        **kwargs: Additional keyword arguments to pass to the model</span>
<span class="sd">        distance_matrix_values(jax device array): matrix of distances between sites, shape [#sites,#sites]</span>
<span class="sd">    Returns:</span>
<span class="sd">        MCMC numpyro instance (class object): An MCMC class object with functions such as .get_samples() and .run()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">starttime</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>

    <span class="n">kernel</span> <span class="o">=</span> <span class="n">NUTS</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">mcmc</span> <span class="o">=</span> <span class="n">MCMC</span><span class="p">(</span>
        <span class="n">kernel</span><span class="p">,</span> <span class="n">num_warmup</span><span class="o">=</span><span class="n">num_warmup</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="n">num_samples</span><span class="p">,</span> <span class="n">num_chains</span><span class="o">=</span><span class="n">num_chains</span>
    <span class="p">)</span>

    <span class="n">mcmc</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">rng_key</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">mcmc</span><span class="o">.</span><span class="n">print_summary</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time Taken:&quot;</span><span class="p">,</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">starttime</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mcmc</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>As we’re utilising a Bayesian framework, we’ll have to define some prior distributions for the parameters. While in theory the prior distribution should represent our state of knowledge before observing the data and so if we have no additional knowledge should be fully non-informative, in practice it’s common to at least set sensible bounds using the exploratory analysis to limit the complexity of the inference space. Here, we compute some basic metrics, which we then use to help set sensible priors.</p>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Useful Metrics for Priors: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
      <span class="sa">f</span><span class="s2">&quot;&quot;&quot;mean odata:</span>
<span class="s2">      min=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;odata&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">      mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;odata&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">      max=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;odata&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">      var=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanvar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;odata&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">      </span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
      <span class="sa">f</span><span class="s2">&quot;&quot;&quot;logvar odata:</span>
<span class="s2">      min=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanvar</span><span class="p">(</span><span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;odata&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)))</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">      mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanvar</span><span class="p">(</span><span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;odata&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)))</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">      max=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanvar</span><span class="p">(</span><span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;odata&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)))</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">      var=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanvar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanvar</span><span class="p">(</span><span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;odata&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)))</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">      </span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
      <span class="sa">f</span><span class="s2">&quot;&quot;&quot;mean cdata:</span>
<span class="s2">      min=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;cdata&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">      mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;cdata&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">      max=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;cdata&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">      var=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanvar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;cdata&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">      </span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
      <span class="sa">f</span><span class="s2">&quot;&quot;&quot;logvar cdata:</span>
<span class="s2">      min=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanvar</span><span class="p">(</span><span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;cdata&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)))</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">      mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanvar</span><span class="p">(</span><span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;cdata&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)))</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">      max=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanvar</span><span class="p">(</span><span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;cdata&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)))</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">      var=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanvar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanvar</span><span class="p">(</span><span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;cdata&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)))</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">      </span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Useful Metrics for Priors: 
 mean odata:
      min=-65.0,
      mean=-33.4,
      max=-13.4,
      var=155.0,
      
 logvar odata:
      min=-4.9,
      mean=1.7,
      max=4.1,
      var=1.1,
      
 mean cdata:
      min=-62.8,
      mean=-39.6,
      max=-12.6,
      var=154.6,
      
 logvar cdata:
      min=0.6,
      mean=2.1,
      max=3.3,
      var=0.2,
      
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Setting priors</span>
<span class="n">data_dictionary</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
    <span class="s2">&quot;omean_b0_prior&quot;</span><span class="p">:</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">-</span><span class="mf">33.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">),</span>
    <span class="s2">&quot;omean_b1_prior&quot;</span><span class="p">:</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">),</span>
    <span class="s2">&quot;omean_b2_prior&quot;</span><span class="p">:</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">),</span>
    <span class="s2">&quot;omean_noise_prior&quot;</span><span class="p">:</span> <span class="n">dist</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mf">1e-2</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">),</span>
    <span class="s2">&quot;ologvar_b0_prior&quot;</span><span class="p">:</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">),</span>
    <span class="s2">&quot;ologvar_noise_prior&quot;</span><span class="p">:</span> <span class="n">dist</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mf">1e-3</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">),</span>
<span class="p">})</span>

<span class="n">data_dictionary</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
    <span class="s2">&quot;cmean_b0_prior&quot;</span><span class="p">:</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">-</span><span class="mf">39.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">),</span>
    <span class="s2">&quot;cmean_noise_prior&quot;</span><span class="p">:</span> <span class="n">dist</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mf">1e-2</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">),</span>
    <span class="s2">&quot;clogvar_b0_prior&quot;</span><span class="p">:</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">),</span>
    <span class="s2">&quot;clogvar_noise_prior&quot;</span><span class="p">:</span> <span class="n">dist</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mf">1e-3</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">),</span>
<span class="p">})</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>The code for running the inference and saving estimates of the parameter posterior distributions is given below. Note that the code is commented out as instead of running the inference within this notebook, for computational reasons we’ll simply load in the output. The output is saved using the ArViZ package, which handles inference data from lots of different probabilisitic programming packages and can be used to produce nice summary metrics and plots.</p>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd"># %% Running inference</span>
<span class="sd">mcmc = run_inference(meanfunc_model, rng_key, 1000, 2000,4, data_dictionary)</span>

<span class="sd">idata = az.from_numpyro(mcmc,</span>
<span class="sd">                coords={</span>
<span class="sd">                &quot;station&quot;: data_dictionary[&#39;ds_aws_preprocessed&#39;][&#39;station&#39;],</span>
<span class="sd">                &quot;x&quot;: data_dictionary[&#39;ds_climate_preprocessed&#39;][&#39;x&#39;],</span>
<span class="sd">    },</span>
<span class="sd">                dims={&quot;clogvar&quot;: [&quot;x&quot;],</span>
<span class="sd">                      &quot;cmean&quot;: [&quot;x&quot;],</span>
<span class="sd">                      &quot;ologvar&quot;: [&quot;station&quot;],</span>
<span class="sd">                      &quot;omean&quot;: [&quot;station&quot;],})</span>
<span class="sd">meanfunc_posterior = idata.posterior</span>


<span class="sd"># Computing the residuals from the mean function model parameters</span>
<span class="sd">meanfunc_posterior = meanfunc_posterior.assign_coords({&#39;oele_scaled&#39;:(&#39;station&#39;, data_dictionary[&#39;oele_scaled&#39;]),</span>
<span class="sd">                        &#39;olat_scaled&#39;:(&#39;station&#39;, data_dictionary[&#39;olat_scaled&#39;]),</span>
<span class="sd">                        &#39;cele_scaled&#39;:(&#39;x&#39;, data_dictionary[&#39;cele_scaled&#39;]),</span>
<span class="sd">                        &#39;clat_scaled&#39;:(&#39;x&#39;, data_dictionary[&#39;clat_scaled&#39;])})</span>
<span class="sd">meanfunc_posterior[&#39;omean_func&#39;] = meanfunc_posterior[&#39;omean_b0&#39;]+meanfunc_posterior[&#39;omean_b1&#39;]*meanfunc_posterior[&#39;oele_scaled&#39;]+meanfunc_posterior[&#39;omean_b2&#39;]*meanfunc_posterior[&#39;olat_scaled&#39;]</span>
<span class="sd">meanfunc_posterior[&#39;cmean_func&#39;] = meanfunc_posterior[&#39;cmean_b0&#39;]+meanfunc_posterior[&#39;omean_b1&#39;]*meanfunc_posterior[&#39;cele_scaled&#39;]+meanfunc_posterior[&#39;omean_b2&#39;]*meanfunc_posterior[&#39;clat_scaled&#39;]</span>
<span class="sd">meanfunc_posterior[&#39;ologvar_func&#39;] = meanfunc_posterior[&#39;ologvar_b0&#39;]</span>
<span class="sd">meanfunc_posterior[&#39;clogvar_func&#39;] = meanfunc_posterior[&#39;clogvar_b0&#39;]</span>
<span class="sd">meanfunc_posterior[&#39;omean_func_residual&#39;] = meanfunc_posterior[&#39;omean&#39;]-meanfunc_posterior[&#39;omean_func&#39;]</span>
<span class="sd">meanfunc_posterior[&#39;cmean_func_residual&#39;] = meanfunc_posterior[&#39;cmean&#39;]-meanfunc_posterior[&#39;cmean_func&#39;]</span>
<span class="sd">meanfunc_posterior[&#39;ologvar_func_residual&#39;] = meanfunc_posterior[&#39;ologvar&#39;]-meanfunc_posterior[&#39;ologvar_func&#39;]</span>
<span class="sd">meanfunc_posterior[&#39;clogvar_func_residual&#39;] = meanfunc_posterior[&#39;clogvar&#39;]-meanfunc_posterior[&#39;clogvar_func&#39;]</span>

<span class="sd">data_dictionary[&#39;meanfunc_posterior&#39;] = meanfunc_posterior</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/home/jez/Bias_Correction_Application/walkthrough_tutorial/data_dictionary.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">data_dictionary</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="n">meanfunc_posterior</span> <span class="o">=</span> <span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;meanfunc_posterior&#39;</span><span class="p">]</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/jez/miniconda3/envs/jbook_BCA/lib/python3.10/site-packages/sklearn/base.py:380: InconsistentVersionWarning: Trying to unpickle estimator StandardScaler from version 1.5.2 when using version 1.6.1. This might lead to breaking code or invalid results. Use at your own risk. For more info please refer to:
https://scikit-learn.org/stable/model_persistence.html#security-maintainability-limitations
  warnings.warn(
</pre></div>
</div>
</div>
</details>
</div>
<p>MCMC is an approximate procedure and it is difficult to assess directly whether the samples returned from the inference accurately capture the true posterior distributions of the parameters. The effective sample size (ESS) and r_hat diagonostics provide some indication, we’re looking for values of r_hat in the range (1.0, 1.05) and ESS that are comparable to the total number of samples, which we get in this run:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">meanfunc_posterior</span><span class="p">[[</span><span class="s1">&#39;omean_b0&#39;</span><span class="p">,</span>
            <span class="s1">&#39;omean_b1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;omean_b2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;omean_noise&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ologvar_b0&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ologvar_noise&#39;</span><span class="p">,</span>
            <span class="s1">&#39;cmean_b0&#39;</span><span class="p">,</span>
            <span class="s1">&#39;cmean_noise&#39;</span><span class="p">,</span>
            <span class="s1">&#39;clogvar_b0&#39;</span><span class="p">,</span>
            <span class="p">]],</span><span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_2.5%</th>
      <th>hdi_97.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>omean_b0</th>
      <td>-33.427</td>
      <td>0.538</td>
      <td>-34.507</td>
      <td>-32.400</td>
      <td>0.005</td>
      <td>0.003</td>
      <td>12208.0</td>
      <td>6100.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>omean_b1</th>
      <td>-9.653</td>
      <td>0.364</td>
      <td>-10.384</td>
      <td>-8.957</td>
      <td>0.004</td>
      <td>0.003</td>
      <td>9882.0</td>
      <td>6581.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>omean_b2</th>
      <td>2.272</td>
      <td>0.382</td>
      <td>1.514</td>
      <td>3.020</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>11987.0</td>
      <td>5646.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>omean_noise</th>
      <td>6.687</td>
      <td>0.395</td>
      <td>5.939</td>
      <td>7.466</td>
      <td>0.004</td>
      <td>0.003</td>
      <td>9233.0</td>
      <td>5215.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>ologvar_b0</th>
      <td>2.043</td>
      <td>0.066</td>
      <td>1.912</td>
      <td>2.170</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>4334.0</td>
      <td>5317.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>ologvar_noise</th>
      <td>0.584</td>
      <td>0.064</td>
      <td>0.463</td>
      <td>0.710</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>2349.0</td>
      <td>4263.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>cmean_b0</th>
      <td>-33.185</td>
      <td>0.563</td>
      <td>-34.340</td>
      <td>-32.126</td>
      <td>0.006</td>
      <td>0.004</td>
      <td>9869.0</td>
      <td>6152.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>cmean_noise</th>
      <td>5.271</td>
      <td>0.385</td>
      <td>4.579</td>
      <td>6.061</td>
      <td>0.004</td>
      <td>0.003</td>
      <td>10785.0</td>
      <td>5511.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>clogvar_b0</th>
      <td>2.216</td>
      <td>0.043</td>
      <td>2.131</td>
      <td>2.299</td>
      <td>0.001</td>
      <td>0.000</td>
      <td>6882.0</td>
      <td>6119.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="inference-on-parameters-of-the-residual-and-covariance-functions">
<h3><a class="toc-backref" href="#id15" role="doc-backlink">Inference on parameters of the residual and covariance functions</a><a class="headerlink" href="#inference-on-parameters-of-the-residual-and-covariance-functions" title="Link to this heading">#</a></h3>
<p>For component 2 of the model, the residuals of the mean and log(standard dev.) are treated as independent and so for simplicity we only show the code defining the model for the residual of the mean <span class="math notranslate nohighlight">\(r_{\mu_Y}(s)\)</span> and <span class="math notranslate nohighlight">\(r_{\mu_Z}(s)\)</span>. Again utilising the Numpyro python package to define the model gives:</p>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Helper functions to be used in the residual model</span>

<span class="k">def</span> <span class="nf">diagonal_noise</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">noise</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">noise</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">generate_obs_conditional_climate_dist</span><span class="p">(</span>
    <span class="n">ox</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cdata</span><span class="p">,</span> <span class="n">ckernel</span><span class="p">,</span> <span class="n">cdiag</span><span class="p">,</span> <span class="n">okernel</span><span class="p">,</span> <span class="n">odiag</span>
<span class="p">):</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="n">cdata</span>
    <span class="n">u1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">ox</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">u2</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">cx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">k11</span> <span class="o">=</span> <span class="n">okernel</span><span class="p">(</span><span class="n">ox</span><span class="p">,</span> <span class="n">ox</span><span class="p">)</span> <span class="o">+</span> <span class="n">diagonal_noise</span><span class="p">(</span><span class="n">ox</span><span class="p">,</span> <span class="n">odiag</span><span class="p">)</span>
    <span class="n">k12</span> <span class="o">=</span> <span class="n">okernel</span><span class="p">(</span><span class="n">ox</span><span class="p">,</span> <span class="n">cx</span><span class="p">)</span>
    <span class="n">k21</span> <span class="o">=</span> <span class="n">okernel</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">ox</span><span class="p">)</span>
    <span class="n">k22</span> <span class="o">=</span> <span class="n">ckernel</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cx</span><span class="p">)</span> <span class="o">+</span> <span class="n">diagonal_noise</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cdiag</span><span class="p">)</span>
    <span class="n">k22i</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">k22</span><span class="p">)</span>
    <span class="n">u1g2</span> <span class="o">=</span> <span class="n">u1</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">k12</span><span class="p">,</span> <span class="n">k22i</span><span class="p">),</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">u2</span><span class="p">)</span>
    <span class="n">l22</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">k22</span><span class="p">)</span>
    <span class="n">l22i</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">l22</span><span class="p">)</span>
    <span class="n">p21</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">l22i</span><span class="p">,</span> <span class="n">k21</span><span class="p">)</span>
    <span class="n">k1g2</span> <span class="o">=</span> <span class="n">k11</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">p21</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">p21</span><span class="p">)</span>
    <span class="n">mvn_dist</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">MultivariateNormal</span><span class="p">(</span><span class="n">u1g2</span><span class="p">,</span> <span class="n">k1g2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mvn_dist</span>

<span class="c1"># The residual model for the mean temperature</span>

<span class="k">def</span> <span class="nf">residual_model_mean</span><span class="p">(</span><span class="n">data_dictionary</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Example model where the residual of the mean for the climate data is generated from 2 GPs,</span>
<span class="sd">    one of which also generates the observations and one of which generates bias in the climate model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">meanfunc_posterior</span> <span class="o">=</span> <span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;meanfunc_posterior&#39;</span><span class="p">]</span>
    <span class="n">omean_func_residual_exp</span> <span class="o">=</span> <span class="n">meanfunc_posterior</span><span class="p">[</span><span class="s1">&#39;omean_func_residual&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="s1">&#39;draw&#39;</span><span class="p">,</span><span class="s1">&#39;chain&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">data</span>
    <span class="n">omean_func_residual_var</span> <span class="o">=</span> <span class="n">meanfunc_posterior</span><span class="p">[</span><span class="s1">&#39;omean_func_residual&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">([</span><span class="s1">&#39;draw&#39;</span><span class="p">,</span><span class="s1">&#39;chain&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">data</span>
    <span class="n">cmean_func_residual_exp_subsample</span> <span class="o">=</span> <span class="n">meanfunc_posterior</span><span class="p">[</span><span class="s1">&#39;cmean_func_residual&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;random_sample&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="s1">&#39;draw&#39;</span><span class="p">,</span><span class="s1">&#39;chain&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">data</span>
    
    <span class="n">kern_var</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;kern_var&quot;</span><span class="p">,</span> <span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;omean_func_residual_kvprior&#39;</span><span class="p">])</span>
    <span class="n">lengthscale</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;lengthscale&quot;</span><span class="p">,</span> <span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;omean_func_residual_klprior&#39;</span><span class="p">])</span>
    <span class="n">kernel</span> <span class="o">=</span> <span class="n">kern_var</span> <span class="o">*</span> <span class="n">kernels</span><span class="o">.</span><span class="n">Matern32</span><span class="p">(</span><span class="n">lengthscale</span><span class="p">,</span><span class="n">L2Distance</span><span class="p">())</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;noise&quot;</span><span class="p">,</span> <span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;omean_func_residual_nprior&#39;</span><span class="p">])</span>
    <span class="n">var_obs</span> <span class="o">=</span> <span class="n">omean_func_residual_var</span>
    
    <span class="n">bkern_var</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;bkern_var&quot;</span><span class="p">,</span> <span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;bmean_func_residual_kvprior&#39;</span><span class="p">])</span>
    <span class="n">blengthscale</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;blengthscale&quot;</span><span class="p">,</span> <span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;bmean_func_residual_klprior&#39;</span><span class="p">])</span>
    <span class="n">bkernel</span> <span class="o">=</span> <span class="n">bkern_var</span> <span class="o">*</span> <span class="n">kernels</span><span class="o">.</span><span class="n">Matern32</span><span class="p">(</span><span class="n">blengthscale</span><span class="p">,</span><span class="n">L2Distance</span><span class="p">())</span>
    <span class="n">bnoise</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;bnoise&quot;</span><span class="p">,</span> <span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;bmean_func_residual_nprior&#39;</span><span class="p">])</span>

    <span class="n">ckernel</span> <span class="o">=</span> <span class="n">kernel</span> <span class="o">+</span> <span class="n">bkernel</span>
    <span class="n">cnoise</span> <span class="o">=</span> <span class="n">noise</span> <span class="o">+</span> <span class="n">bnoise</span> 
    <span class="n">cgp</span> <span class="o">=</span> <span class="n">GaussianProcess</span><span class="p">(</span><span class="n">ckernel</span><span class="p">,</span> <span class="n">data_dictionary</span><span class="p">[</span><span class="s2">&quot;cx_subsample&quot;</span><span class="p">],</span> <span class="n">diag</span><span class="o">=</span><span class="n">cnoise</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;climate_temperature&quot;</span><span class="p">,</span>
                   <span class="n">cgp</span><span class="o">.</span><span class="n">numpyro_dist</span><span class="p">(),</span>
                   <span class="n">obs</span><span class="o">=</span><span class="n">cmean_func_residual_exp_subsample</span><span class="p">)</span>

    <span class="n">obs_conditional_climate_dist</span> <span class="o">=</span> <span class="n">generate_obs_conditional_climate_dist</span><span class="p">(</span>
        <span class="n">data_dictionary</span><span class="p">[</span><span class="s2">&quot;ox&quot;</span><span class="p">],</span>
        <span class="n">data_dictionary</span><span class="p">[</span><span class="s2">&quot;cx_subsample&quot;</span><span class="p">],</span>
        <span class="n">cmean_func_residual_exp_subsample</span><span class="p">,</span>
        <span class="n">ckernel</span><span class="p">,</span>
        <span class="n">cnoise</span><span class="p">,</span>
        <span class="n">kernel</span><span class="p">,</span>
        <span class="n">var_obs</span><span class="o">+</span><span class="n">noise</span>
    <span class="p">)</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="s2">&quot;obs_temperature&quot;</span><span class="p">,</span>
        <span class="n">obs_conditional_climate_dist</span><span class="p">,</span>
        <span class="n">obs</span><span class="o">=</span><span class="n">omean_func_residual_exp</span>
    <span class="p">)</span>

<span class="c1"># Function for running the MCMC inference and generating the posterior distributions for the model</span>

<span class="k">def</span> <span class="nf">generate_posterior_residual_model_mean</span><span class="p">(</span><span class="n">data_dictionary</span><span class="p">,</span>
                                    <span class="n">rng_key</span><span class="p">,</span>
                                    <span class="n">num_warmup</span><span class="p">,</span>
                                    <span class="n">num_samples</span><span class="p">,</span>
                                    <span class="n">num_chains</span><span class="p">):</span>
    <span class="n">mcmc_residual_model_mean</span> <span class="o">=</span> <span class="n">run_inference</span><span class="p">(</span>
        <span class="n">residual_model_mean</span><span class="p">,</span>
        <span class="n">rng_key</span><span class="p">,</span>
        <span class="n">num_warmup</span><span class="p">,</span>
        <span class="n">num_samples</span><span class="p">,</span>
        <span class="n">num_chains</span><span class="p">,</span>
        <span class="n">data_dictionary</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">idata_residual_model_mean</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_numpyro</span><span class="p">(</span><span class="n">mcmc_residual_model_mean</span><span class="p">)</span>
    <span class="n">data_dictionary</span><span class="p">[</span><span class="s2">&quot;idata_residual_model_mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">idata_residual_model_mean</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>In the model definition for the residuals the observations are the expectations of the residuals computed from inference of the meanfunction model in component 1. That is <span class="math notranslate nohighlight">\(E[r_{\mu_Y}(s_Y)]\)</span> and <span class="math notranslate nohighlight">\(E[r_{\mu_Z}(s_Z)]\)</span>. The uncertainty in these values is captured through the variance, so <span class="math notranslate nohighlight">\(V[r_{\mu_Y}(s_Y)]\)</span> and <span class="math notranslate nohighlight">\(V[r_{\mu_Z}(s_Z)]\)</span>. Although, we don’t include <span class="math notranslate nohighlight">\(V[r_{\mu_Z}(s_Z)]\)</span> in the model definition as it’s an insignificant quantity. The model follows the equations:</p>
<div class="math notranslate nohighlight">
\[r_{\mu_Y}(s) \sim \mathcal{GP}(0|,k(s,s'|l_{\mu_Y},v_{\mu_Y},n_{\mu_Y})) \hspace{2em} r_{\mu_B}(s) \sim \mathcal{GP}(0|,k(s,s'|l_{\mu_B},v_{\mu_B},n_{\mu_B}))\]</div>
<div class="math notranslate nohighlight">
\[r_{\mu_Z}(s) = r_{\mu_Y}(s)+r_{\mu_B}(s)\]</div>
<div class="math notranslate nohighlight">
\[k(s,s')=v(1+\dfrac{\sqrt{3}|s-s'|}{l}exp\left({-\dfrac{\sqrt{3}|s-s'|}{l}}\right)\]</div>
<div class="note dropdown admonition">
<p class="admonition-title">Function ‘generate_obs_conditional_climate_dist’:</p>
<p>The function ‘generate_obs_conditional_climate_dist’ is defined as the parameters of <span class="math notranslate nohighlight">\(\mathcal{GP}(0|,k(s,s'|l_{\mu_Y},v_{\mu_Y},n_{\mu_Y}))\)</span> and <span class="math notranslate nohighlight">\(\mathcal{GP}(0|,k(s,s'|l_{\mu_B},v_{\mu_B},n_{\mu_B}))\)</span> are conditional on both <span class="math notranslate nohighlight">\(r_{\mu_Y}(s_Y)\)</span> and <span class="math notranslate nohighlight">\(r_{\mu_Z}(s_Z)\)</span>. So we generate a distribution for the probability of the unbiased AWS data given the already conditioned on climate model data.</p>
</div>
<p>Again choosing sensible priors for the parameters of the model that have reasonable bounds based on some basic summary metrics:</p>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Useful metrics for priors</span>
<span class="n">exp_omean_func_residual</span> <span class="o">=</span> <span class="n">meanfunc_posterior</span><span class="p">[</span><span class="s1">&#39;omean_func_residual&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="s1">&#39;draw&#39;</span><span class="p">,</span><span class="s1">&#39;chain&#39;</span><span class="p">])</span>
<span class="n">ox_ranges</span> <span class="o">=</span> <span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;ox&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;ox&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Useful Metrics for Priors: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
      <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">      Mean Obs:</span>
<span class="s2">      min=</span><span class="si">{</span><span class="n">exp_omean_func_residual</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">      mean=</span><span class="si">{</span><span class="n">exp_omean_func_residual</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">      max=</span><span class="si">{</span><span class="n">exp_omean_func_residual</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">      var=</span><span class="si">{</span><span class="n">exp_omean_func_residual</span><span class="o">.</span><span class="n">var</span><span class="p">()</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">      &quot;&quot;&quot;</span><span class="p">,</span>
      <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Obs Axis Ranges=</span><span class="si">{</span><span class="n">ox_ranges</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Useful Metrics for Priors: 
 
      Mean Obs:
      min=-17.0,
      mean=-0.0,
      max=16.9,
      var=42.2,
       
 Obs Axis Ranges=[45.47068137 34.36497791]
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Setting priors</span>
<span class="n">lengthscale_max</span> <span class="o">=</span> <span class="mi">20</span>

<span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;omean_func_residual_kvprior&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">100.0</span><span class="p">)</span>
<span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;omean_func_residual_klprior&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">lengthscale_max</span><span class="p">)</span>
<span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;omean_func_residual_nprior&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">20.0</span><span class="p">)</span>

<span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;bmean_func_residual_kvprior&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">100.0</span><span class="p">)</span>
<span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;bmean_func_residual_klprior&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">lengthscale_max</span><span class="p">)</span>
<span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;bmean_func_residual_nprior&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">20.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>The code for running the inference and saving estimates of the parameter posterior distributions is given below. Note that the code is commented out as instead of running the inference within this notebook, for computational reasons we’ll simply load in the output.</p>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Running the inference</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">generate_posterior_residual_model_mean(data_dictionary,</span>
<span class="sd">                                rng_key,</span>
<span class="sd">                                1000,</span>
<span class="sd">                                1000,</span>
<span class="sd">                                4)</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/home/jez/Bias_Correction_Application/walkthrough_tutorial/data_dictionary.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">data_dictionary</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="n">idata_residual_model_mean</span> <span class="o">=</span> <span class="n">data_dictionary</span><span class="p">[</span><span class="s2">&quot;idata_residual_model_mean&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">idata_residual_model_mean</span><span class="o">.</span><span class="n">posterior</span><span class="p">,</span><span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_2.5%</th>
      <th>hdi_97.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>bkern_var</th>
      <td>9.901</td>
      <td>9.807</td>
      <td>0.139</td>
      <td>27.480</td>
      <td>0.206</td>
      <td>0.151</td>
      <td>2914.0</td>
      <td>2274.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>blengthscale</th>
      <td>14.087</td>
      <td>4.209</td>
      <td>6.159</td>
      <td>19.999</td>
      <td>0.073</td>
      <td>0.054</td>
      <td>2800.0</td>
      <td>1890.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>bnoise</th>
      <td>0.937</td>
      <td>0.841</td>
      <td>0.100</td>
      <td>2.626</td>
      <td>0.013</td>
      <td>0.010</td>
      <td>3027.0</td>
      <td>1737.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>kern_var</th>
      <td>37.062</td>
      <td>9.573</td>
      <td>22.317</td>
      <td>56.631</td>
      <td>0.248</td>
      <td>0.200</td>
      <td>2273.0</td>
      <td>1412.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>lengthscale</th>
      <td>3.211</td>
      <td>0.623</td>
      <td>2.080</td>
      <td>4.427</td>
      <td>0.015</td>
      <td>0.011</td>
      <td>1848.0</td>
      <td>1669.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>noise</th>
      <td>5.591</td>
      <td>1.233</td>
      <td>3.329</td>
      <td>8.132</td>
      <td>0.024</td>
      <td>0.017</td>
      <td>2496.0</td>
      <td>2571.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The posterior distributions for the parameters of the model appear sensible on first glance. The r-hat statistic indicates that the chains are independent as desired and the effective sample size is of comparable magnitude to the total number of samples taken.</p>
</section>
<section id="making-posterior-predictive-estimates-of-the-unbiased-mean-and-variance-across-the-domain">
<h3><a class="toc-backref" href="#id16" role="doc-backlink">Making posterior predictive estimates of the unbiased mean and variance across the domain</a><a class="headerlink" href="#making-posterior-predictive-estimates-of-the-unbiased-mean-and-variance-across-the-domain" title="Link to this heading">#</a></h3>
<p>From the previous section we have:</p>
<ul class="simple">
<li><p>Posterior estimates of the mean and log-variance at the AWS sites and climate model grid cells, that is <span class="math notranslate nohighlight">\(\mu_Y(s_Y)\)</span>, <span class="math notranslate nohighlight">\(\tilde{\sigma}_Y(s_Y)\)</span>, <span class="math notranslate nohighlight">\(\mu_Z(s_Z)\)</span> and <span class="math notranslate nohighlight">\(\tilde{\sigma}_Z(s_Z)\)</span>. As well as the estimates for the meanfunction and residual components: <span class="math notranslate nohighlight">\(m_{\mu_Y}(s_Y)\)</span>, <span class="math notranslate nohighlight">\(m_{\tilde{\sigma}_Y}(s_Y)\)</span>, <span class="math notranslate nohighlight">\(m_{\mu_Z}(s_Z)\)</span>, <span class="math notranslate nohighlight">\(m_{\tilde{\sigma}_Z}(s_Z)\)</span> and <span class="math notranslate nohighlight">\(r_{\mu_Y}(s_Y)\)</span>, <span class="math notranslate nohighlight">\(r_{\tilde{\sigma}_Y}(s_Y)\)</span>, <span class="math notranslate nohighlight">\(r_{\mu_Z}(s_Z)\)</span> and <span class="math notranslate nohighlight">\(r_{\tilde{\sigma}_Z}(s_Z)\)</span>.</p></li>
<li><p>Posterior estimates of the parameters of the mean functions, so <span class="math notranslate nohighlight">\(\beta_{0,\mu_Y}\)</span>, <span class="math notranslate nohighlight">\(\beta_{1,\mu}\)</span>, <span class="math notranslate nohighlight">\(\beta_{2,\mu}\)</span>, <span class="math notranslate nohighlight">\(\beta_{0,\mu_Z}\)</span>, <span class="math notranslate nohighlight">\(\beta_{0,\tilde{\sigma}_Y}\)</span> and <span class="math notranslate nohighlight">\(\beta_{0,\tilde{\sigma}_Z}\)</span>.</p></li>
<li><p>Posterior estimates of the parameters of the covariance functions, so <span class="math notranslate nohighlight">\(l_{\mu_Y}\)</span>, <span class="math notranslate nohighlight">\(v_{\mu_Y}\)</span>, <span class="math notranslate nohighlight">\(n_{\mu_Y}\)</span>, <span class="math notranslate nohighlight">\(l_{\mu_B}\)</span>, <span class="math notranslate nohighlight">\(v_{\mu_B}\)</span> and <span class="math notranslate nohighlight">\(n_{\mu_B}\)</span>.</p></li>
</ul>
<p>Now we want to make estimates of the posterior distributions of the unbiased mean and log-variance at the climate model locations to use for bias correction, so <span class="math notranslate nohighlight">\(\mu_Y(s_Z)\)</span> and <span class="math notranslate nohighlight">\(\tilde{\sigma}_Y(s_Z)\)</span>. This is known as the posterior predictive and involves conditioning on both the inferred parameters of the model and the observed data. Since we split up the hierarchical model, to get <span class="math notranslate nohighlight">\(\mu_Y(s_Z)\)</span> and <span class="math notranslate nohighlight">\(\tilde{\sigma}_Y(s_Z)\)</span> we’ll get estimates for <span class="math notranslate nohighlight">\(m_{\mu_Y}(s_Z)\)</span> and <span class="math notranslate nohighlight">\(m_{\tilde{\sigma}_Y}(s_Z)\)</span> from the first component of the model, then <span class="math notranslate nohighlight">\(r_{\mu_Y}(s_Z)\)</span> and <span class="math notranslate nohighlight">\(r_{\tilde{\sigma}_Y}(s_Z)\)</span> from the second component.</p>
<div class="note dropdown admonition">
<p class="admonition-title">Posterior predictive calculation:</p>
<p>Let the collection of parameters for the model be:
<span class="math notranslate nohighlight">\(\phi = [m_{\mu_Y}(s_Y), m_{\mu_Z}(s_Z), r_{\mu_Y}(s_Y), r_{\mu_Z}(s_Z),
\beta_{0,\mu_Y}, \beta_{1,\mu}, \beta_{2,\mu}, \beta_{0,\mu_Z},
l_{\mu_Y}, v_{\mu_Y}, n_{\mu_Y}, l_{\mu_B}, v_{\mu_B}, n_{\mu_B}]\)</span></p>
<p>Then the posterior predictive distributions is given by:</p>
<div class="math notranslate nohighlight">
\[p(\mu_Y(\hat{s})|Y(s_Y),Z(s_Z))=\]</div>
<div class="math notranslate nohighlight">
\[\int 
p(m_{\mu_Y}(\hat{s})|\beta_{0,\mu_Y}, \beta_{1,\mu}, \beta_{2,\mu}, \beta_{0,\mu_Z})
\cdot 
p(r_{\mu_Y}(\hat{s})|r_{\mu_Y}(s_Y), r_{\mu_Z}(s_Z),l_{\mu_Y}, v_{\mu_Y}, n_{\mu_Y}, l_{\mu_B}, v_{\mu_B}, n_{\mu_B})
\cdot
p(\theta|Y(s_Y),Z(s_Z)) d\theta\]</div>
<p>Where <span class="math notranslate nohighlight">\(p(m_{\mu_Y}(\hat{s})|\beta_{0,\mu_Y}, \beta_{1,\mu}, \beta_{2,\mu}, \beta_{0,\mu_Z})\)</span> is the predictive distribution of the meanfunction and <span class="math notranslate nohighlight">\(p(r_{\mu_Y}(\hat{s})|r_{\mu_Y}(s_Y), r_{\mu_Z}(s_Z),l_{\mu_Y}, v_{\mu_Y}, n_{\mu_Y}, l_{\mu_B}, v_{\mu_B}, n_{\mu_B})\)</span> is the predictive distribution of the residual function. The distribution <span class="math notranslate nohighlight">\(p(\theta|Y(s_Y),Z(s_Z))\)</span> is simply the posterior distribution for the parameters of our model, which we get samples from using MCMC.</p>
<p>To get samples of <span class="math notranslate nohighlight">\(\mu_Y(\hat{s})\)</span> from the posterior predictive distribution we take samples from the predictive distribution of the meanfunction and the predictive distribution of the residual using parameters sampled from the posterior. That is for each sample from our MCMC inference, we define the predictive distributions and then take a sample.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/home/jez/Bias_Correction_Application/walkthrough_tutorial/data_dictionary_new.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">data_dictionary_new</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/jez/miniconda3/envs/jbook_BCA/lib/python3.10/site-packages/sklearn/base.py:380: InconsistentVersionWarning: Trying to unpickle estimator StandardScaler from version 1.5.2 when using version 1.6.1. This might lead to breaking code or invalid results. Use at your own risk. For more info please refer to:
https://scikit-learn.org/stable/model_persistence.html#security-maintainability-limitations
  warnings.warn(
</pre></div>
</div>
</div>
</div>
<p>Sampling the predictive distribution of the mean function is simple:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">meanfunc_postpredictive_parameters</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;omean_b0&#39;</span><span class="p">,</span><span class="s1">&#39;omean_b1&#39;</span><span class="p">,</span><span class="s1">&#39;omean_b2&#39;</span><span class="p">]</span>
<span class="n">meanfunc_postpredictive</span> <span class="o">=</span> <span class="n">data_dictionary</span><span class="p">[</span><span class="s2">&quot;meanfunc_posterior&quot;</span><span class="p">][</span><span class="n">meanfunc_postpredictive_parameters</span><span class="p">]</span>
<span class="n">meanfunc_posterior</span><span class="p">[</span><span class="s1">&#39;unbiased_meanfunc_predictive&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">meanfunc_posterior</span><span class="p">[</span><span class="s1">&#39;omean_b0&#39;</span><span class="p">]</span><span class="o">+</span>
                                                           <span class="n">meanfunc_posterior</span><span class="p">[</span><span class="s1">&#39;omean_b1&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">meanfunc_posterior</span><span class="p">[</span><span class="s1">&#39;cele_scaled&#39;</span><span class="p">]</span><span class="o">+</span>
                                                           <span class="n">meanfunc_posterior</span><span class="p">[</span><span class="s1">&#39;omean_b2&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">meanfunc_posterior</span><span class="p">[</span><span class="s1">&#39;clat_scaled&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>Sampling the predictive distribution of the residual is more difficult and we construct some functions to help.</p>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># %% Defining function for generating posterior predictive realisations of the residuals</span>

<span class="k">def</span> <span class="nf">generate_truth_predictive_dist_mean</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">data_dictionary</span><span class="p">,</span> <span class="n">posterior_param_realisation</span><span class="p">):</span>
    <span class="n">kern_var_realisation</span> <span class="o">=</span> <span class="n">posterior_param_realisation</span><span class="p">[</span><span class="s2">&quot;kern_var_realisation&quot;</span><span class="p">]</span>
    <span class="n">lengthscale_realisation</span> <span class="o">=</span> <span class="n">posterior_param_realisation</span><span class="p">[</span><span class="s2">&quot;lengthscale_realisation&quot;</span><span class="p">]</span>
    <span class="n">noise_realisation</span> <span class="o">=</span> <span class="n">posterior_param_realisation</span><span class="p">[</span><span class="s2">&quot;noise_realisation&quot;</span><span class="p">]</span>

    <span class="n">bkern_var_realisation</span> <span class="o">=</span> <span class="n">posterior_param_realisation</span><span class="p">[</span><span class="s2">&quot;bkern_var_realisation&quot;</span><span class="p">]</span>
    <span class="n">blengthscale_realisation</span> <span class="o">=</span> <span class="n">posterior_param_realisation</span><span class="p">[</span><span class="s2">&quot;blengthscale_realisation&quot;</span><span class="p">]</span>
    <span class="n">bnoise_realisation</span> <span class="o">=</span> <span class="n">posterior_param_realisation</span><span class="p">[</span><span class="s2">&quot;bnoise_realisation&quot;</span><span class="p">]</span>

    <span class="n">meanfunc_posterior</span> <span class="o">=</span> <span class="n">data_dictionary</span><span class="p">[</span><span class="s1">&#39;meanfunc_posterior&#39;</span><span class="p">]</span>
    <span class="n">omean_func_residual_exp</span> <span class="o">=</span> <span class="n">meanfunc_posterior</span><span class="p">[</span><span class="s1">&#39;omean_func_residual&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="s1">&#39;draw&#39;</span><span class="p">,</span><span class="s1">&#39;chain&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">data</span>
    <span class="n">omean_func_residual_var</span> <span class="o">=</span> <span class="n">meanfunc_posterior</span><span class="p">[</span><span class="s1">&#39;omean_func_residual&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">([</span><span class="s1">&#39;draw&#39;</span><span class="p">,</span><span class="s1">&#39;chain&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">data</span>
    <span class="n">cmean_func_residual_exp</span> <span class="o">=</span> <span class="n">meanfunc_posterior</span><span class="p">[</span><span class="s1">&#39;cmean_func_residual&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="s1">&#39;draw&#39;</span><span class="p">,</span><span class="s1">&#39;chain&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">data</span>

    <span class="n">ox</span> <span class="o">=</span> <span class="n">data_dictionary</span><span class="p">[</span><span class="s2">&quot;ox&quot;</span><span class="p">]</span>
    <span class="n">cx</span> <span class="o">=</span> <span class="n">data_dictionary</span><span class="p">[</span><span class="s2">&quot;cx&quot;</span><span class="p">]</span>
    <span class="n">odata</span> <span class="o">=</span> <span class="n">omean_func_residual_exp</span>
    <span class="n">odata_var</span> <span class="o">=</span> <span class="n">omean_func_residual_var</span>
    <span class="n">cdata</span> <span class="o">=</span> <span class="n">cmean_func_residual_exp</span>
    <span class="n">kernelo</span> <span class="o">=</span> <span class="n">kern_var_realisation</span> <span class="o">*</span> <span class="n">kernels</span><span class="o">.</span><span class="n">Matern32</span><span class="p">(</span><span class="n">lengthscale_realisation</span><span class="p">,</span><span class="n">L2Distance</span><span class="p">())</span>
    <span class="n">kernelb</span> <span class="o">=</span> <span class="n">bkern_var_realisation</span> <span class="o">*</span> <span class="n">kernels</span><span class="o">.</span><span class="n">Matern32</span><span class="p">(</span><span class="n">blengthscale_realisation</span><span class="p">,</span><span class="n">L2Distance</span><span class="p">())</span>

    <span class="n">noise</span> <span class="o">=</span> <span class="n">noise_realisation</span> <span class="o">+</span> <span class="n">odata_var</span>
    <span class="n">bnoise</span> <span class="o">=</span> <span class="n">bnoise_realisation</span>
    <span class="n">cnoise</span> <span class="o">=</span> <span class="n">noise_realisation</span> <span class="o">+</span> <span class="n">bnoise</span>

    <span class="n">jitter</span> <span class="o">=</span> <span class="mf">1e-5</span>

    <span class="n">y2</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">odata</span><span class="p">,</span> <span class="n">cdata</span><span class="p">])</span>
    <span class="n">u1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">u2</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
        <span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">ox</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">cx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)]</span>
    <span class="p">)</span>
    <span class="n">k11</span> <span class="o">=</span> <span class="n">kernelo</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span> <span class="o">+</span> <span class="n">diagonal_noise</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">jitter</span><span class="p">)</span>
    <span class="n">k12</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">kernelo</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ox</span><span class="p">),</span> <span class="n">kernelo</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">cx</span><span class="p">)])</span>
    <span class="n">k21</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">kernelo</span><span class="p">(</span><span class="n">ox</span><span class="p">,</span> <span class="n">nx</span><span class="p">),</span> <span class="n">kernelo</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">nx</span><span class="p">)])</span>
    <span class="n">k22_upper</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
        <span class="p">[</span><span class="n">kernelo</span><span class="p">(</span><span class="n">ox</span><span class="p">,</span> <span class="n">ox</span><span class="p">)</span> <span class="o">+</span> <span class="n">diagonal_noise</span><span class="p">(</span><span class="n">ox</span><span class="p">,</span> <span class="n">noise</span><span class="p">),</span> <span class="n">kernelo</span><span class="p">(</span><span class="n">ox</span><span class="p">,</span> <span class="n">cx</span><span class="p">)]</span>
    <span class="p">)</span>
    <span class="n">k22_lower</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">kernelo</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">ox</span><span class="p">),</span>
            <span class="n">kernelo</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cx</span><span class="p">)</span> <span class="o">+</span> <span class="n">kernelb</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cx</span><span class="p">)</span> <span class="o">+</span> <span class="n">diagonal_noise</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cnoise</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">k22</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">k22_upper</span><span class="p">,</span> <span class="n">k22_lower</span><span class="p">])</span>
    <span class="n">k22</span> <span class="o">=</span> <span class="n">k22</span>
    <span class="n">k22i</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">k22</span><span class="p">)</span>

    <span class="n">u1g2</span> <span class="o">=</span> <span class="n">u1</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">k12</span><span class="p">,</span> <span class="n">k22i</span><span class="p">),</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">u2</span><span class="p">)</span>
    <span class="n">k1g2</span> <span class="o">=</span> <span class="n">k11</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">k12</span><span class="p">,</span> <span class="n">k22i</span><span class="p">),</span> <span class="n">k21</span><span class="p">)</span>
    <span class="n">mvn</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">MultivariateNormal</span><span class="p">(</span><span class="n">u1g2</span><span class="p">,</span> <span class="n">k1g2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mvn</span>


<span class="k">def</span> <span class="nf">generate_posterior_predictive_realisations_dualprocess_mean</span><span class="p">(</span>
    <span class="n">nx</span><span class="p">,</span>
    <span class="n">data_dictionary</span><span class="p">,</span>
    <span class="n">num_parameter_realisations</span><span class="p">,</span>
    <span class="n">num_posterior_pred_realisations</span><span class="p">,</span>
    <span class="n">rng_key</span>
<span class="p">):</span>
    <span class="n">posterior</span> <span class="o">=</span> <span class="n">data_dictionary</span><span class="p">[</span><span class="s2">&quot;idata_residual_model_mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">posterior</span>
    <span class="n">truth_posterior_predictive_realisations</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">iteration</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">posterior</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_parameter_realisations</span><span class="p">)):</span>
        <span class="n">posterior_param_realisation</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;iteration&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
            <span class="s2">&quot;kern_var_realisation&quot;</span><span class="p">:</span> <span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;kern_var&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:][</span><span class="n">i</span><span class="p">],</span>
            <span class="s2">&quot;lengthscale_realisation&quot;</span><span class="p">:</span> <span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;lengthscale&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:][</span><span class="n">i</span><span class="p">],</span>
            <span class="s2">&quot;noise_realisation&quot;</span><span class="p">:</span> <span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;noise&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:][</span><span class="n">i</span><span class="p">],</span>
            <span class="s2">&quot;bkern_var_realisation&quot;</span><span class="p">:</span> <span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;bkern_var&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:][</span><span class="n">i</span><span class="p">],</span>
            <span class="s2">&quot;blengthscale_realisation&quot;</span><span class="p">:</span> <span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;blengthscale&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:][</span><span class="n">i</span><span class="p">],</span>
            <span class="s2">&quot;bnoise_realisation&quot;</span><span class="p">:</span> <span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;bnoise&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:][</span><span class="n">i</span><span class="p">],</span>
        <span class="p">}</span>

        <span class="n">truth_predictive_dist</span> <span class="o">=</span> <span class="n">generate_truth_predictive_dist_mean</span><span class="p">(</span>
            <span class="n">nx</span><span class="p">,</span> <span class="n">data_dictionary</span><span class="p">,</span> <span class="n">posterior_param_realisation</span>
        <span class="p">)</span>
        <span class="n">iteration</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">truth_predictive_realisations</span> <span class="o">=</span> <span class="n">truth_predictive_dist</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
            <span class="n">rng_key</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="n">num_posterior_pred_realisations</span><span class="p">,)</span>
        <span class="p">)</span>
        <span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_key_</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key</span><span class="p">)</span>

        <span class="n">truth_posterior_predictive_realisations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">truth_predictive_realisations</span><span class="p">)</span>

    <span class="n">truth_posterior_predictive_realisations</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="n">truth_posterior_predictive_realisations</span>
    <span class="p">)</span>

    <span class="n">residual_pospred_ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;hyperparameter_draws&#39;</span><span class="p">:</span><span class="nb">range</span><span class="p">(</span><span class="n">num_parameter_realisations</span><span class="p">),</span>
              <span class="s1">&#39;gp_draws&#39;</span><span class="p">:</span><span class="nb">range</span><span class="p">(</span><span class="n">num_posterior_pred_realisations</span><span class="p">),</span>
              <span class="s1">&#39;nx&#39;</span><span class="p">:</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nx</span><span class="p">)),</span>
              <span class="p">},</span>
    <span class="n">data_vars</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;unbiased_mean_residual_postpred&#39;</span><span class="p">:([</span><span class="s1">&#39;hyperparameter_draws&#39;</span><span class="p">,</span><span class="s1">&#39;gp_draws&#39;</span><span class="p">,</span><span class="s1">&#39;nx&#39;</span><span class="p">],</span> <span class="n">truth_posterior_predictive_realisations</span><span class="p">),</span>
                <span class="p">}</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">residual_pospred_ds</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>Generating the residual posterior predictive samples:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generating posterior predictive realisations of the residuals</span>
<span class="n">residual_postpred</span> <span class="o">=</span> <span class="n">generate_posterior_predictive_realisations_dualprocess_mean</span><span class="p">(</span>
    <span class="n">data_dictionary</span><span class="p">[</span><span class="s2">&quot;cx&quot;</span><span class="p">],</span>
    <span class="n">data_dictionary</span><span class="p">,</span>
    <span class="mi">100</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="n">rng_key</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 100/100 [00:44&lt;00:00,  2.24it/s]
</pre></div>
</div>
</div>
</div>
<p>Computing the expectations and uncertainties:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">unbiased_meanfunc_predictive_exp</span> <span class="o">=</span> <span class="n">meanfunc_postpredictive</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="s1">&#39;draw&#39;</span><span class="p">,</span><span class="s1">&#39;chain&#39;</span><span class="p">])[</span><span class="s1">&#39;unbiased_meanfunc_predictive&#39;</span><span class="p">]</span>
<span class="n">unbiased_meanfunc_predictive_var</span> <span class="o">=</span> <span class="n">meanfunc_postpredictive</span><span class="o">.</span><span class="n">var</span><span class="p">([</span><span class="s1">&#39;draw&#39;</span><span class="p">,</span><span class="s1">&#39;chain&#39;</span><span class="p">])[</span><span class="s1">&#39;unbiased_meanfunc_predictive&#39;</span><span class="p">]</span>

<span class="n">residual_postpred_exp</span> <span class="o">=</span> <span class="n">residual_postpred</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="s1">&#39;gp_draws&#39;</span><span class="p">,</span><span class="s1">&#39;hyperparameter_draws&#39;</span><span class="p">])</span>
<span class="n">residual_postpred_var</span> <span class="o">=</span> <span class="n">residual_postpred</span><span class="o">.</span><span class="n">var</span><span class="p">([</span><span class="s1">&#39;gp_draws&#39;</span><span class="p">,</span><span class="s1">&#39;hyperparameter_draws&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewBox="0 0 32 32">
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewBox="0 0 32 32">
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme="dark"],
html[data-theme="dark"],
body[data-theme="dark"],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1f1f1f;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block !important;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 0 20px 0 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: inline-block;
  opacity: 0;
  height: 0;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:focus + label {
  border: 2px solid var(--xr-font-color0);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: "►";
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: "▼";
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: "(";
}

.xr-dim-list:after {
  content: ")";
}

.xr-dim-list li:not(:last-child):after {
  content: ",";
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-index-preview {
  grid-column: 2 / 5;
  color: var(--xr-font-color2);
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data,
.xr-index-data-in:checked ~ .xr-index-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-index-name div,
.xr-index-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2,
.xr-no-icon {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style><pre class='xr-text-repr-fallback'>&lt;xarray.DataArray &#x27;unbiased_meanfunc_predictive&#x27; (cx_whole: 5724)&gt; Size: 46kB
Array([-25.047113  , -23.22933811, -23.69891625, ..., -18.4898046 ,
       -18.20454335, -18.25322313], dtype=float64)
Coordinates:
  * cx_whole           (cx_whole) int64 46kB 0 1 2 3 4 ... 5720 5721 5722 5723
    cele_whole         (cx_whole) float64 46kB ...
    clat_whole         (cx_whole) float64 46kB ...
    cele_scaled_whole  (cx_whole) float64 46kB ...
    clat_scaled_whole  (cx_whole) float64 46kB ...</pre><div class='xr-wrap' style='display:none'><div class='xr-header'><div class='xr-obj-type'>xarray.DataArray</div><div class='xr-array-name'>'unbiased_meanfunc_predictive'</div><ul class='xr-dim-list'><li><span class='xr-has-index'>cx_whole</span>: 5724</li></ul></div><ul class='xr-sections'><li class='xr-section-item'><div class='xr-array-wrap'><input id='section-bcc8a8e8-b273-4325-b215-65ce805f0133' class='xr-array-in' type='checkbox' checked><label for='section-bcc8a8e8-b273-4325-b215-65ce805f0133' title='Show/hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-array-preview xr-preview'><span>...</span></div><div class='xr-array-data'><pre>Array([-25.047113  , -23.22933811, -23.69891625, ..., -18.4898046 ,
       -18.20454335, -18.25322313], dtype=float64)</pre></div></div></li><li class='xr-section-item'><input id='section-f122616b-3bea-4932-aca7-1365f63bba84' class='xr-section-summary-in' type='checkbox'  checked><label for='section-f122616b-3bea-4932-aca7-1365f63bba84' class='xr-section-summary' >Coordinates: <span>(5)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>cx_whole</span></div><div class='xr-var-dims'>(cx_whole)</div><div class='xr-var-dtype'>int64</div><div class='xr-var-preview xr-preview'>0 1 2 3 4 ... 5720 5721 5722 5723</div><input id='attrs-5355a645-0bcf-470a-8ad5-f9b7c6c8301b' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-5355a645-0bcf-470a-8ad5-f9b7c6c8301b' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-0ba1c0f9-2bb0-49ed-880f-a6b08185f364' class='xr-var-data-in' type='checkbox'><label for='data-0ba1c0f9-2bb0-49ed-880f-a6b08185f364' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([   0,    1,    2, ..., 5721, 5722, 5723])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>cele_whole</span></div><div class='xr-var-dims'>(cx_whole)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>...</div><input id='attrs-4bd42e88-f79e-4f50-a317-e48fa80ec389' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-4bd42e88-f79e-4f50-a317-e48fa80ec389' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-45df5ae4-c292-4d4d-abb9-06207b74178b' class='xr-var-data-in' type='checkbox'><label for='data-45df5ae4-c292-4d4d-abb9-06207b74178b' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>Array([890.34930428, 684.94936791, 701.02459634, ...,  36.30484251,
        22.81620079,  30.78442191], dtype=float64)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>clat_whole</span></div><div class='xr-var-dims'>(cx_whole)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>...</div><input id='attrs-cac52341-bf5f-4fad-b2ad-a90dfedc4553' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-cac52341-bf5f-4fad-b2ad-a90dfedc4553' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-7da83fb7-70a4-48b6-ab9d-846a1a99ec67' class='xr-var-data-in' type='checkbox'><label for='data-7da83fb7-70a4-48b6-ab9d-846a1a99ec67' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>Array([-64.09387608, -63.97399186, -64.73930155, ..., -65.90702752,
       -65.51603869, -65.47025386], dtype=float64)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>cele_scaled_whole</span></div><div class='xr-var-dims'>(cx_whole)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>...</div><input id='attrs-d19d1b2f-6679-429a-87c0-373fe4bbac42' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-d19d1b2f-6679-429a-87c0-373fe4bbac42' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-07cfe263-4cc6-47ec-b853-867b6f5ee9ad' class='xr-var-data-in' type='checkbox'><label for='data-07cfe263-4cc6-47ec-b853-867b6f5ee9ad' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>Array([-0.3170727 , -0.49999805, -0.48568175, ..., -1.07766877,
       -1.0896815 , -1.08258515], dtype=float64)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>clat_scaled_whole</span></div><div class='xr-var-dims'>(cx_whole)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>...</div><input id='attrs-3d6c5e32-aec2-4881-871b-863aad0e08da' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-3d6c5e32-aec2-4881-871b-863aad0e08da' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-18cbb2c5-0eaa-4026-9023-9a228e4afc9a' class='xr-var-data-in' type='checkbox'><label for='data-18cbb2c5-0eaa-4026-9023-9a228e4afc9a' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>Array([2.34153503, 2.36438599, 2.21851141, ..., 1.99593283, 2.07045865,
       2.07918563], dtype=float64)</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-5756b680-5c7d-46d3-859c-1cbaebe487bd' class='xr-section-summary-in' type='checkbox'  ><label for='section-5756b680-5c7d-46d3-859c-1cbaebe487bd' class='xr-section-summary' >Indexes: <span>(1)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-index-name'><div>cx_whole</div></div><div class='xr-index-preview'>PandasIndex</div><input type='checkbox' disabled/><label></label><input id='index-f8888031-74c5-40c7-a7aa-945fac5e83d1' class='xr-index-data-in' type='checkbox'/><label for='index-f8888031-74c5-40c7-a7aa-945fac5e83d1' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Index([   0,    1,    2,    3,    4,    5,    6,    7,    8,    9,
       ...
       5714, 5715, 5716, 5717, 5718, 5719, 5720, 5721, 5722, 5723],
      dtype=&#x27;int64&#x27;, name=&#x27;cx_whole&#x27;, length=5724))</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-b7ee8dd6-3239-464a-b375-866dafca7aac' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-b7ee8dd6-3239-464a-b375-866dafca7aac' class='xr-section-summary'  title='Expand/collapse section'>Attributes: <span>(0)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><dl class='xr-attrs'></dl></div></li></ul></div></div></div></div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks\methods\Bias_Correction_Application"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../../../intro.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">UKCEH Data Science Book</p>
      </div>
    </a>
    <a class="right-next"
       href="../gradient_boosted_trees.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Content needs filling.</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#importing-required-libraries-and-loading-data">Importing Required Libraries and Loading Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-exploration">Data Exploration</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-distribution-of-weather-stations">Spatial Distribution of Weather Stations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#time-series-and-distribution-of-single-weather-station-manuela">Time Series and Distribution of Single Weather Station (Manuela)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pairplots">Pairplots</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#examining-spatial-covariance-after-removing-influence-of-elevation-and-latitude">Examining spatial covariance after removing influence of elevation and latitude</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#examining-spatial-covariance-in-the-bias">Examining spatial covariance in the bias</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#examining-relationships-between-variables-and-the-bias-in-parameters">Examining relationships between variables and the bias in parameters</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-preprocessing">Data Preprocessing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-the-model">Defining the model</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#splitting-up-the-model-for-computation">Splitting up the model for computation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#parameter-inference">Parameter Inference</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#inference-on-parameters-of-the-mean-function">Inference on parameters of the mean function</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#inference-on-parameters-of-the-residual-and-covariance-functions">Inference on parameters of the residual and covariance functions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#making-posterior-predictive-estimates-of-the-unbiased-mean-and-variance-across-the-domain">Making posterior predictive estimates of the unbiased mean and variance across the domain</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The Jupyter Book Community
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>